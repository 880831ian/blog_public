<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式) - PinYi 部落格</title><meta name="description" content="這裡是關於一個菜鳥工程師斜槓Youtuber的部落格"><meta property="og:title" content="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)" />
<meta property="og:description" content="本篇是 Laravel 介紹 的進階篇，由於有些說明介紹會沿用上一篇的內容，建議要先瀏覽過上一篇呦～ (可以從這裡下載最後程式碼！) Laravel 內建會員系統 Laravel 這個框架，很" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.pin-yi.me/laravel-advanced/" /><meta property="og:image" content="https://blog.pin-yi.me/laravel-advanced/featured-image.webp"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-08T09:00:59+08:00" />
<meta property="article:modified_time" content="2022-04-04T11:18:41+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.pin-yi.me/laravel-advanced/featured-image.webp"/>
<meta name="twitter:title" content="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)"/>
<meta name="twitter:description" content="本篇是 Laravel 介紹 的進階篇，由於有些說明介紹會沿用上一篇的內容，建議要先瀏覽過上一篇呦～ (可以從這裡下載最後程式碼！) Laravel 內建會員系統 Laravel 這個框架，很"/>
<meta name="application-name" content="PinYi 部落格">
<meta name="apple-mobile-web-app-title" content="PinYi 部落格"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/avatar.webp"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.pin-yi.me/laravel-advanced/" /><link rel="prev" href="https://blog.pin-yi.me/redis/" /><link rel="next" href="https://blog.pin-yi.me/docker/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css">
        <link href="https://www.googletagmanager.com" rel="preconnect" crossorigin>
        <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)",
        "inLanguage": "zh-tw",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.pin-yi.me\/laravel-advanced\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/blog.pin-yi.me\/laravel-advanced\/featured-image.webp",
                            "width":  2520 ,
                            "height":  896 
                        }],"genre": "posts","keywords": "PHP, 框架, Laravel, RESTful API, Repository, 實作, 介紹","wordcount":  7783 ,
        "url": "https:\/\/blog.pin-yi.me\/laravel-advanced\/","datePublished": "2022-03-08T09:00:59+08:00","dateModified": "2022-04-04T11:18:41+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhuang,Pin-Yi","logo": "https:\/\/blog.pin-yi.me\/images\/avatar.webp"},"author": {
                "@type": "Person",
                "name": "PinYi"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EK8X0P9SDS"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-EK8X0P9SDS', { 'anonymize_ip': false });
}
</script>
</head><body data-header-desktop="fixed" data-header-mobile="fixed"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="PinYi 部落格">PinYi 部落格</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 文章分類 </a><a class="menu-item" href="/tags/"> 文章標籤 </a><a class="menu-item" href="/categories/youtube/"> YouTube 影片 </a><a class="menu-item" href="https://pin-yi.me" rel="noopener noreffer" target="_blank"> 關於我 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a class="menu-item" href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="PinYi 部落格">PinYi 部落格</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">文章分類</a><a class="menu-item" href="/tags/" title="">文章標籤</a><a class="menu-item" href="/categories/youtube/" title="">YouTube 影片</a><a class="menu-item" href="https://pin-yi.me" title="" rel="noopener noreffer" target="_blank">關於我</a><div class="menu-item"><a href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a>
                <span>&nbsp;|&nbsp;</span><a href="javascript:void(0);" class="theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目錄</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/laravel-advanced/featured-image.webp"
        data-srcset="/laravel-advanced/featured-image.webp, /laravel-advanced/featured-image.webp 1.5x, /laravel-advanced/featured-image.webp 2x"
        data-sizes="auto"
        alt="/laravel-advanced/featured-image.webp"
        title="/laravel-advanced/featured-image.webp" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://pin-yi.me" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>PinYi</a></span>&nbsp;<span class="post-category">出版於  <a href="/categories/codenotes/"><i class="far fa-folder fa-fw"></i>程式筆記</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-08">2022-03-08</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;約 7783 字</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;預計閱讀 16 分鐘</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>目錄</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#laravel-內建會員系統">Laravel 內建會員系統</a>
      <ul>
        <li><a href="#實作">實作</a>
          <ul>
            <li><a href="#migration">Migration</a></li>
            <li><a href="#view">View</a>
              <ul>
                <li><a href="#loginblade">Login.blade</a></li>
                <li><a href="#registerblade">Register.blade</a></li>
              </ul>
            </li>
            <li><a href="#model">Model</a></li>
            <li><a href="#controller">Controller</a>
              <ul>
                <li><a href="#registercontroller">RegisterController</a></li>
                <li><a href="#logincontroller">LoginController</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#驗證-restful-api-是否登入">驗證 RESTful API 是否登入</a>
          <ul>
            <li><a href="#repository-設計模式">Repository 設計模式</a></li>
            <li><a href="#migration-1">Migration</a></li>
            <li><a href="#登入-api">登入 API</a></li>
            <li><a href="#middleware">Middleware</a></li>
            <li><a href="#route">Route</a></li>
            <li><a href="#model-1">Model</a></li>
            <li><a href="#repository">Repository</a></li>
            <li><a href="#controller-1">Controller</a></li>
          </ul>
        </li>
        <li><a href="#postman-測試">Postman 測試</a>
          <ul>
            <li><a href="#登入">登入</a></li>
            <li><a href="#新增留言---成功">新增留言 - 成功</a></li>
            <li><a href="#新增留言---失敗">新增留言 - 失敗</a></li>
            <li><a href="#修改留言---成功">修改留言 - 成功</a></li>
            <li><a href="#修改留言---失敗---沒有登入">修改留言 - 失敗 - 沒有登入</a></li>
            <li><a href="#修改留言---失敗---權限不足">修改留言 - 失敗 - 權限不足</a></li>
            <li><a href="#按讚留言---成功">按讚留言 - 成功</a></li>
            <li><a href="#按讚留言---失敗---沒有登入">按讚留言 - 失敗 - 沒有登入</a></li>
            <li><a href="#刪除留言---成功">刪除留言 - 成功</a></li>
            <li><a href="#刪除留言---失敗---沒有登入">刪除留言 - 失敗 - 沒有登入</a></li>
            <li><a href="#刪除留言---失敗---權限不足">刪除留言 - 失敗 - 權限不足</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>本篇是 <a href="https://pin-yi.me/laravel/" target="_blank" rel="noopener noreffer">Laravel 介紹</a> 的進階篇，由於有些說明介紹會沿用上一篇的內容，建議要先瀏覽過上一篇呦～ (<a href="https://github.com/880831ian/laravel-restful-api-messageboard" target="_blank" rel="noopener noreffer">可以從這裡下載最後程式碼！</a>)</p>
<h2 id="laravel-內建會員系統">Laravel 內建會員系統</h2>
<p>Laravel 這個框架，很方便的地方就是，他可以將我們常用的帳號登入註冊等功能內建在 Laravel 框架內，那我們來看一下要怎麼使用吧。(本篇 Laravel Framework：5.4.36)</p>
<p>它的配置文件在 <code>config/auth.php</code> ，其中包含了用於調整認證服務行為或是標注選項配置等。</p>
<br>
<p>要怎麼開始呢!? 先使用 <code>artisan</code> 指令產生我們要的檔案以及路由吧！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ php artisan make:auth
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>主要會產生</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">	new file:   app/Http/Controllers/HomeController.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/auth/login.blade.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/auth/passwords/email.blade.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/auth/passwords/reset.blade.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/auth/register.blade.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/home.blade.php
</span></span><span class="line"><span class="cl">	new file:   resources/views/layouts/app.blade.php
</span></span><span class="line"><span class="cl">	modified:   routes/web.php
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>其中 <code>routes/web.php</code> 多了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">Auth</span><span class="o">::</span><span class="na">routes</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="s1">&#39;HomeController@index&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>views 底下放的就是顯示的畫面，所以現在可以瀏覽</p>
<p>登入頁面：<code>http://127.0.0.1:8000/login</code></p>
<p>註冊頁面：<code>http://127.0.0.1:8000/register</code></p>
<p>其他像是 <code>controller</code> 或是 <code>migration</code> 都已經內建在裡面了，稍後實作會講到！</p>
<br>
<h3 id="實作">實作</h3>
<h4 id="migration">Migration</h4>
<p>我們照上一篇的流程，由於 <code>route</code> 已經設定好，所以我們先來設定 <code>migration</code> ， 檔案就放在 <code>database/migrations</code> 底下的 <code>{日期時間}_create_users_table.php</code> ，我們來看一下預設的資料表有哪些欄位吧!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unique</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">rememberToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">timestamps</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Reverse the migrations.
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">dropIfExists</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>簡單看一下，他會建立一個名叫 <code>users</code> 的資料表，欄位分別有自動累加(id)、字串(name)、唯一字串(email)、字串(密碼)、rememberToken()、timestamps()。</p>
<br>
<p>那我們這次想要做的事，不使用 email 做登入，改成使用 username來當作登入驗證，所以我們把 name、email的欄位改成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unique</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">rememberToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">timestamps</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Reverse the migrations.
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">dropIfExists</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定 username 欄位為唯一值，移除掉 email ，再加入一個 api_token 用於後續的 RESTful API 驗證。</p>
<br>
<p>使用 <code>php artisan migrate</code> 將 <code>users</code> 這個 table 給建起來。</p>
<p>因為我們修改 name、email 改成 username 這個欄位，所以我們也要修改一下 views 顯示的畫面，由於是簡單的 HTML 這邊就不再多描述，直接放上修改後的程式碼。</p>
<h4 id="view">View</h4>
<h5 id="loginblade">Login.blade</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group{{ $errors-&gt;has(&#39;username&#39;) ? &#39; has-error&#39; : &#39;&#39; }}&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;col-md-4 control-label&#34;</span><span class="p">&gt;</span>Username<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;col-md-6&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;{{ old(&#39;username&#39;) }}&#34;</span> <span class="na">required</span> <span class="na">autofocus</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                               
</span></span><span class="line"><span class="cl">    @if ($errors-&gt;has(&#39;username&#39;))
</span></span><span class="line"><span class="cl">           <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;help-block&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                   <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{ $errors-&gt;first(&#39;username&#39;) }}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">           <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    @endif
</span></span><span class="line"><span class="cl"> <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="registerblade">Register.blade</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group{{ $errors-&gt;has(&#39;username&#39;) ? &#39; has-error&#39; : &#39;&#39; }}&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;col-md-4 control-label&#34;</span><span class="p">&gt;</span>Username<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;col-md-6&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  	<span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;username&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;{{ old(&#39;username&#39;) }}&#34;</span> <span class="na">required</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     @if ($errors-&gt;has(&#39;username&#39;))
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;help-block&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{ $errors-&gt;first(&#39;username&#39;) }}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">     @endif
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div> <br>
<h4 id="model">Model</h4>
<p>接下來到 <code>app</code> 底下找到 <code>User.php</code> 檔案，由於筆者習慣將 <code>model</code> 放到專屬的資料夾，不要讓他在 <code>app</code> 裡面流浪，所以會建立一個 <code>Models</code>  的資料夾，來存放所有的 <code>models</code> ，那移動原本的 <code>model</code> 有些有使用到它的路徑都要做修改，這邊以 <code>User</code> 檔案為示範。(因為後續會說到怎麼驗證登入 API ，所以上一篇的 Message model 也要記得修改歐！)</p>
 <br>
<p>因為我們移動後，原本的路徑是 <code>App</code> 要改成 <code>App\Models</code>，會影響到的程式有以下幾個 (附上片段程式碼)</p>
<ul>
<li><code>config/auth.php</code> 約在70行左右</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;eloquent&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nx">App\Models\User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="c1">//修改片段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">],</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<ul>
<li><code>config/services.php</code> 約在33行左右</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="s1">&#39;stripe&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="nx">App\Models\User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="c1">//修改片段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;STRIPE_KEY&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;secret&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;STRIPE_SECRET&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<ul>
<li><code>database/factories/UserFactory.php</code> 約在15行左右</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">define</span><span class="p">(</span><span class="nx">App\Models\User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Faker\Generator</span> <span class="nv">$faker</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//修改片段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">static</span> <span class="nv">$password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$faker</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$faker</span><span class="o">-&gt;</span><span class="na">unique</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">safeEmail</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span> <span class="o">?:</span> <span class="nv">$password</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;remember_token&#39;</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<ul>
<li><code>app/Http/Controllers/Auth/RegisterController.php</code> 約在5行左右</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>都修改好了，我們就繼續來修改 <code>User</code> 這個 model ，將原本的 name、email ，修改成以下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Notifications\Notifiable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Foundation\Auth\User</span> <span class="k">as</span> <span class="nx">Authenticatable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Authenticatable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">use</span> <span class="nx">Notifiable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">    * The attributes that are mass assignable.
</span></span></span><span class="line"><span class="cl"><span class="sd">    *
</span></span></span><span class="line"><span class="cl"><span class="sd">    * @var array
</span></span></span><span class="line"><span class="cl"><span class="sd">    */</span>
</span></span><span class="line"><span class="cl">   <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;username&#39;</span><span class="p">,</span>  <span class="s1">&#39;password&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">    * The attributes that should be hidden for arrays.
</span></span></span><span class="line"><span class="cl"><span class="sd">    *
</span></span></span><span class="line"><span class="cl"><span class="sd">    * @var array
</span></span></span><span class="line"><span class="cl"><span class="sd">    */</span>
</span></span><span class="line"><span class="cl">   <span class="k">protected</span> <span class="nv">$hidden</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;password&#39;</span><span class="p">,</span>  <span class="s1">&#39;remember_token&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div> <br>
<p>裡面有一個是 <code>fillable</code> 跟 <code>hiddem</code> ，順便解釋一下這兩個是在做什麼</p>
<ul>
<li>fillable：當使用者輸入這些 attribute 以外的參數(資料表的欄位)，就會發生錯誤。</li>
<li>hidden：想要限制能出現在陣列或是JSON 格式的屬性資料，比如密碼欄位等等，不想要顯示，只需要把該欄位加入 <code>hidden</code>。</li>
</ul>
<p>再加碼一個</p>
<ul>
<li>guarded：這個屬性與 <code>fillable</code> 相反，當使用者輸入該參數的值，就會被擋掉。以下這個例子是允許任何的 input 資料，但十分建議不要這樣。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$guarded</span> <span class="o">=</span> <span class="p">[];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<h4 id="controller">Controller</h4>
<p>接下來是要修改我們的 controller，主要需要修改的有兩個，檔案在 <code>app\Http\Auth</code> 底下的 <code>registerController</code> 、 <code>loginController</code> 兩個檔案，我們先來修改 <code>registerController</code> 註冊功能，看一下原本的程式碼在做什麼事情。</p>
<h5 id="registercontroller">RegisterController</h5>
<br>
原本程式碼
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">    protected <span class="k">function</span> validator<span class="o">(</span>array <span class="nv">$data</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> Validator::make<span class="o">(</span><span class="nv">$data</span>, <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;required|string|max:255&#39;</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;email&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;required|string|email|max:255|unique:users&#39;</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;required|string|min:6|confirmed&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /**
</span></span><span class="line"><span class="cl">     * Create a new user instance after a valid registration.
</span></span><span class="line"><span class="cl">     *
</span></span><span class="line"><span class="cl">     * @param  array  <span class="nv">$data</span>
</span></span><span class="line"><span class="cl">     * @return <span class="se">\A</span>pp<span class="se">\U</span>ser
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">    protected <span class="k">function</span> create<span class="o">(</span>array <span class="nv">$data</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> User::create<span class="o">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=</span>&gt; <span class="nv">$data</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;email&#39;</span> <span class="o">=</span>&gt; <span class="nv">$data</span><span class="o">[</span><span class="s1">&#39;email&#39;</span><span class="o">]</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=</span>&gt; bcrypt<span class="o">(</span><span class="nv">$data</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">])</span>,
</span></span><span class="line"><span class="cl">        <span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到在 <code>validator()</code> 就是在驗證註冊時的欄位，以 email 來說明，他需要符合必填(required)、字串(string)、email格式(email)、最大長度(max:255)、在 users 資料表中唯一(unique:users) 才可以註冊，另外兩個也是如此。</p>
<p>那 <code>create()</code> 就是會建立註冊的資料到資料表中，就是這麼簡單XD，詳細可以參考 <a href="https://laravel.com/docs/5.4/validation#form-request-validation" target="_blank" rel="noopener noreffer">Laravel 官網 Form Request Validation</a></p>
<br>
<p>那還記得我們把 name、email 給刪掉，改成 username 來做登入嗎，我們來看一下我們要修改哪些東西！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">    protected <span class="k">function</span> validator<span class="o">(</span>array <span class="nv">$data</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> Validator::make<span class="o">(</span><span class="nv">$data</span>, <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;required|string|max:255|unique:users&#39;</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;required|string|min:6|confirmed&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /**
</span></span><span class="line"><span class="cl">     * Create a new user instance after a valid registration.
</span></span><span class="line"><span class="cl">     *
</span></span><span class="line"><span class="cl">     * @param  array  <span class="nv">$data</span>
</span></span><span class="line"><span class="cl">     * @return <span class="se">\A</span>pp<span class="se">\M</span>odels<span class="se">\U</span>ser
</span></span><span class="line"><span class="cl">     */
</span></span><span class="line"><span class="cl">    protected <span class="k">function</span> create<span class="o">(</span>array <span class="nv">$data</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> User::create<span class="o">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=</span>&gt; <span class="nv">$data</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span>,
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=</span>&gt; bcrypt<span class="o">(</span><span class="nv">$data</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">])</span>,
</span></span><span class="line"><span class="cl">        <span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由於我們刪除 email ，所以要把 unique:users 設定在 username。</p>
<br>
<h5 id="logincontroller">LoginController</h5>
<p>註冊頁面都已經修改好了，理論上連線到 <code>http://127.0.0.1:8000/register</code> 頁面，輸入 username 以及 密碼，會可以註冊成功囉，那接下來我們來修改登入的 controller。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">use</span> <span class="nx">AuthenticatesUsers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Where to redirect users after login.
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @var string
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$redirectTo</span> <span class="o">=</span> <span class="s1">&#39;/home&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Create a new controller instance.
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return void
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">except</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因為 Laravel 框架內建了驗證登入功能，所以只需要使用 <code>use AuthenticatesUsers;</code> 就可以達到驗證效果，登入成功就會使用 <code>redirectTo</code> 導向到 <code>/home</code>，那問題來了，因為 <code>AuthenticatesUsers</code> 預設是使用 email 來做登入驗證，但我們改成 username，我們要怎麼修改呢！？ 一起來看看吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">//由於判斷是用 AuthenticatesUsers 這個內建的 trait 來實作，其中 username() 這個方法就是來指定登入要用的欄位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">username</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;username&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面有說因為使用了 <code>AuthenticatesUsers</code>  來做驗證，我們盡量不去修改框架內的檔案，當然 Laravel 也有配套措施，只要使用 <code>username()</code> 這個方法就可以指定登入要驗證的欄位，因為筆者在學習這段時也找了很久，這邊附上<a href="https://laravel.com/api/6.x/Illuminate/Foundation/Auth/AuthenticatesUsers.html" target="_blank" rel="noopener noreffer"> Laravel API</a> 可以去查看一下。</p>
<p>我們這時就可以使用 <code>http://127.0.0.1:8000/login</code> 來登入囉！試試看吧～</p>
<h3 id="驗證-restful-api-是否登入">驗證 RESTful API 是否登入</h3>
<p>本篇會使用到上一篇的 RESTful API 留言板來進行修改，所以有興趣的朋友，可以先去看玩上一篇 <a href="https://pin-yi.me/laravel" target="_blank" rel="noopener noreffer">Laravel 介紹</a> 歐～</p>
<p>接下來也會同時使用 Repository 設計模式來修改程式碼，那 Repository 設計模式是什麼呢，讓我先來介紹。</p>
<h4 id="repository-設計模式">Repository 設計模式</h4>
<p>還記得我們上一次，把所有的邏輯以及資料庫的處理的都放在 <code>Controller</code> 裡面嗎！如果只是單一個小專案，還可以這樣做沒關係，但專案越來越大，會使用的功能也越來越多，會造成 <code>Controller</code> 檔案肥大且難以維護，基於 SOLID 原則，我們應該要使用 Repository 設計模式來補助  <code>Controller</code>，將相關的資料庫邏輯放在不同的 <code>Repository</code>，方便中大型的專案做維護。</p>
<br> 
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>小知識<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>SOLID：簡單來說就是物件導向設定上為了讓軟體維護、開發變得更容易的五個準則的縮寫。</p>
<ul>
<li>Single Responsibility Principle (SRP) 單一職責原則</li>
<li>Open-Closed Principle (OCP) 開放封閉原則</li>
<li>Liskov Substitution Principle (LSP) 里氏替換原則</li>
<li>Interface Segregation Principle (ISP) 介面隔離原則</li>
<li>Dependency Inversion Principle(DIP) 依賴反轉原則</li>
</ul>
<p>SOLID目的也就是讓你程式碼達成低耦合、高內聚、降低程式碼壞味道，透過分離與clean code來提高可讀性會讓你的程式碼等同於設計文件，所以在修改或新增過程中降低產生Bug的機率，也可以較快的找到與解決出問題的地方，可以有效的減少技術債。</p>
<p>(資料來源：<a href="https://medium.com/@f40507777/%E6%88%91%E8%A9%B2%E5%AD%B8%E6%9C%83solid%E5%97%8E-4e73887c9156" target="_blank" rel="noopener noreffer">我該學會SOLID嗎?</a>)</p>
</div>
        </div>
    </div>
<br>
<p>不太清楚沒關係，我們會慢慢介紹到！那我們先來看看這次要修改什麼呢！？ 我想要在使用 API 時，去檢查有沒有登入，才會進行動作，舉個例子，我們希望在新增留言、修改留言以及刪除留言都需要登入，且是由本人操作才算成功。</p>
<br>
<h4 id="migration-1">Migration</h4>
<p>在此之前，我們先來修改一下上次的 <code>migration</code> {日期時間}_create_message_table.php 檔案吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span> <span class="c1">//留言板編號
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unsigned</span><span class="p">();</span> <span class="c1">//留言者ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">foreign</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="c1">//留言板內容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">default</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">timestamps</span><span class="p">();</span> <span class="c1">//留言板建立以及編輯的時間
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">softDeletes</span><span class="p">();</span> <span class="c1">//軟刪除時間
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到我們將資料庫的名稱從 <code>messsages</code> 改為 <code>message</code> ，後續程式部分也都會修改，大家要在注意一下 ～</p>
<p>我們這次加入了留言者 ID (使用外鍵連接 <code>users</code> 的 <code>id</code>)、按讚者 ID (使用外鍵連接 <code>users</code> 的 <code>id</code>)、留言板樂觀鎖、softDeletes軟刪除的欄位(軟刪除後續會提到)，並且因為我們同樣的資料不要重複儲存，所以刪除 <code>name</code> 要查詢就使用 join 來做查詢。</p>
<p>我們還希望可以多一個來存放是誰按讚的的資料表。所以一樣使用 <code>migration</code>  新增一個 {日期時間}_create_like_table.php 檔案</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">bigIncrements</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span> <span class="c1">//按讚紀錄編號
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unsigned</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">nullable</span><span class="p">();</span> <span class="c1">//文章編號
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">foreign</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unsigned</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">nullable</span><span class="p">();</span> <span class="c1">//帳號編號
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">foreign</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">dateTime</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">);</span> <span class="c1">//按讚紀錄建立時間
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">softDeletes</span><span class="p">();</span> <span class="c1">//軟刪除時間
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>會存放文章的編號並且使用外鍵連接 <code>message </code> 的 <code>id</code>，以及按讚者的 ID 也使用外鍵連接 <code>users </code> 的 <code>id</code>。</p>
<br>
<p>列出本次會使用的功能以及對應的方法、是否需要登入、登入後其他人是否可以操作
<br></p>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">方法</th>
<th style="text-align:center">是否需要登入</th>
<th style="text-align:center">登入後其他人是否可以操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">查詢全部留言</td>
<td style="text-align:center">getAllMessage</td>
<td style="text-align:center">否</td>
<td style="text-align:center">不需登入</td>
</tr>
<tr>
<td style="text-align:center">查詢{id}留言</td>
<td style="text-align:center">getMessage</td>
<td style="text-align:center">否</td>
<td style="text-align:center">不需登入</td>
</tr>
<tr>
<td style="text-align:center">新增留言</td>
<td style="text-align:center">createMessage</td>
<td style="text-align:center">是</td>
<td style="text-align:center">否</td>
</tr>
<tr>
<td style="text-align:center">修改{id}留言</td>
<td style="text-align:center">updateMessage</td>
<td style="text-align:center">是</td>
<td style="text-align:center">否</td>
</tr>
<tr>
<td style="text-align:center">按讚{id}留言</td>
<td style="text-align:center">likeMessage</td>
<td style="text-align:center">是</td>
<td style="text-align:center">可以</td>
</tr>
<tr>
<td style="text-align:center">刪除{id}留言</td>
<td style="text-align:center">deleteMessage</td>
<td style="text-align:center">是</td>
<td style="text-align:center">否</td>
</tr>
</tbody>
</table>
<br>
<h4 id="登入-api">登入 API</h4>
<p>我們上面介紹有使用到 Laravel 內建的登入 LoginController 來進行登入，但通常我們在使用時，都會另外再多一個登入用的 API ，那我們來看一下要怎麼設計吧！</p>
<p>我們先使用 <code>php artisan make:controller LoginController</code> 新增一個登入的 API，他會產生在 <code>app/Http/Controllers/</code> 目錄下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Validator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Auth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoginController</span> <span class="k">extends</span> <span class="nx">Controller</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$rules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(),</span> <span class="nv">$rules</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;格式錯誤&#34;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Auth</span><span class="o">::</span><span class="na">attempt</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">password</span>
</span></span><span class="line"><span class="cl">        <span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;登入失敗&#34;</span><span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;登入成功&#34;</span><span class="p">],</span> <span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">logout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Auth</span><span class="o">::</span><span class="na">logout</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;登出成功&#34;</span><span class="p">],</span> <span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>這邊的 Login 會先驗證格式是否正確，在使用 <code>Auth:attempt</code> 來檢查是否有註冊過，並且回傳相對應的訊息， Logout 就使用 <code>Auth::logout</code> 即可。</p>
<p>好了後我們先到 routes/api.php 新增登入跟登出 API 的路徑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;LoginController@login&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;LoginController@logout&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>我們接下來設定 Middleware ，什麼是 Middleware 呢！？</p>
<h4 id="middleware">Middleware</h4>
<p>Middleware 中文翻譯是中介軟體，是指從發出請求 (Request)之後，到接收回應(Response)這段來回的途徑上，</p>
<p>用來處理特定用途的程式，比較常用的 <strong>Middleware</strong> 有身份認證 (Identity) 、路由(Routing) 等，再舉個例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">某天早上你去圖書館看書，
</span></span><span class="line"><span class="cl">下午去公園畫畫，
</span></span><span class="line"><span class="cl">晚上去KTV 唱歌，
</span></span><span class="line"><span class="cl">等到要準備回家的時候發現學生證不見了，
</span></span><span class="line"><span class="cl">你會去哪裡找? (假設學生證就掉在這3個地方)
</span></span></code></pre></td></tr></table>
</div>
</div><p>對於記憶不好的人來說，會按照 KTV &gt; 公園 &gt; 圖書館的路線去尋找。</p>
<p>假設在公園找到學生證，就不會再去圖書館了，由於這條路是死巷，所以只能返回走去KTV的路，這個就是 <strong>Middleware</strong> 的運作原理。</p>
<p>所以我們需要再請求時，先檢查是否有登入，才可以去執行需要權限的功能。</p>
<p>我們可以使用內建的 <code>Auth::check</code> 來檢查是否有登入，我們接著看要怎麼做吧！</p>
<br>
<p>先下指令生成一個放置登入驗證權限的 <code>Middleware</code> ，我把它取名為 <code>ApiAuth</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$  php artisan make:middleware ApiAuth
</span></span><span class="line"><span class="cl">Middleware created successfully.
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>接著要把剛剛生成的 <code>ApiAuth</code> 檔案放置在 <code>app/Http/Kernel.php</code> 檔案中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$routeMiddleware</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;auth&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Auth\Middleware\Authenticate</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;auth.basic&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;bindings&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Routing\Middleware\SubstituteBindings</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;can&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Auth\Middleware\Authorize</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;guest&#39;</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\RedirectIfAuthenticated</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;throttle&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Routing\Middleware\ThrottleRequests</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;api.auth&#39;</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\ApiAuth</span><span class="o">::</span><span class="na">class</span> <span class="c1">// 這邊
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下來我們就可以開始撰寫 <code>ApiAuth</code> 檔案的內容了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Auth</span><span class="o">::</span><span class="na">check</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">([</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;用戶需要認證&#39;</span><span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>這邊的意思是指，在 request 的時候，我們使用內建的 <code>Auth::check</code> 來檢查，如果登入就可以繼續使用，如果沒有登入會回傳用戶需要認證以及 401 的 status code。</p>
<br>
<h4 id="route">Route</h4>
<p>接下來，我們要把我們設定好的 <code>ApiAuth</code> 設定在 <code>route\api.php</code> 的路由中，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@getAll&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;message/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@get&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@create&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;api.auth&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">put</span><span class="p">(</span><span class="s1">&#39;message/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@update&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;api.auth&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">patch</span><span class="p">(</span><span class="s1">&#39;message/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@like&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;api.auth&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">Route</span><span class="o">::</span><span class="na">delete</span><span class="p">(</span><span class="s1">&#39;message/{id}&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageController@delete&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;api.auth&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到跟我們上一篇的 route 設定的差不多，只是將 <code>MessageController</code> 後面的方法做了一點變化，簡化名稱(這與我們後面講到的 Repository 設計模式有關)，以及加上 <code>like</code> 這個方法來當作我們的按讚功能，後面將我們需要登入驗證才可以使用的功能，加入 <code>middleware('api.auth');</code></p>
<br>
<h4 id="model-1">Model</h4>
<p>因為我們在取得資料時，不希望顯示 <code>deleted_at</code> 給使用者，所以在 <code>app\Models\Message.php</code> 這個 model 裡面用 <code>hidden</code> 來做設定。</p>
<p><strong>message</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\SoftDeletes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Message</span> <span class="k">extends</span> <span class="nx">Model</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">use</span> <span class="nx">SoftDeletes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;Message&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$hidden</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;deleted_at&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到我們還多引用 SoftDeletes ，它叫軟刪除，一般來說我們在設計資料庫時，不會真正意義上的把資料刪掉，還記得我們再新增 message 跟 like 資料表時，有多了一個  <code>softDeletes()</code> 欄位嗎，這個欄位就是當我們刪除時，他會記錄刪除時間，但在查詢時就不會顯示這筆資料，讓使用者覺得資料已經真正刪除了，但實際上資料還是存在在資料庫中。</p>
<br>
<p><strong>like</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\SoftDeletes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Like</span> <span class="k">extends</span> <span class="nx">Model</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">use</span> <span class="nx">SoftDeletes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;like&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;message_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$timestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到我們還多引用 SoftDeletes ，它叫軟刪除，一般來說我們在設計資料庫時，不會真正意義上的把資料刪掉，還記得我們再新增 message 跟 like 資料表時，有多了一個  <code>softDeletes()</code> 欄位嗎，這個欄位就是當我們刪除時，他會記錄刪除時間，但在查詢時就不會顯示這筆資料，讓使用者覺得資料已經真正刪除了，但實際上資料還是存在在資料庫中。</p>
<br>
<h4 id="repository">Repository</h4>
<p>還記得我們上次把 RESTful API 要處理的邏輯都寫在 Controller 裡面嗎，我們光是一個小功能就讓整個 Controller 變得肥大，在後續維護時或是新增功能時，會導致十分不便利，因此我們要將 Repository 設計模式 給導入，那要怎麼實作呢～</p>
<br>
<p>我們要先在 <code>app</code> 底下新增一個 <code>Repositories</code> 目錄，在目錄底下再新增一個 <code>MessageRepository.php</code> 檔案來專門放我們與資料庫拿資料的程式，讓 Controller 單純處理商業邏輯我們整個檔案分成幾段來看</p>
<br>
<p>先新增這個檔案的命名空間，並將我們原先放在 <code>MessageController</code> 的引用給拿進來，我們 Repositories 單純處理與資料庫的交握，或是引用 Message 跟 like 的 Models。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">App\Repositories</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">App\Models\Message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">App\Models\Like</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>查詢留言資料讀取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getAllMessage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Message</span><span class="o">::</span><span class="na">select</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.user_id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;users.username as name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.version&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.created_at&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.updated_at&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">leftjoin</span><span class="p">(</span><span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;message.id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;like.message_id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">leftjoin</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;message.user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;users.id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">selectRaw</span><span class="p">(</span><span class="s1">&#39;count(like.id) as like_count&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">toArray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Message</span><span class="o">::</span><span class="na">select</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.user_id&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;users.username as name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.version&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.created_at&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message.updated_at&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">leftjoin</span><span class="p">(</span><span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;message.id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;like.message_id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">leftjoin</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;message.user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;users.id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">selectRaw</span><span class="p">(</span><span class="s1">&#39;count(like.id) as like_count&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>回傳全部的留言資料 <code>getAllMessage()</code>，由於我們想要顯示留言者 id，只能一個一個把我們想要的 select 出來，不能透過 model 來顯示，使用 leftjoin 來查詢，最後多一個來顯示各個文章的總數。</p>
<p>回傳{id}留言資料 <code>getMessage($id)</code>，一樣跟回傳全部的留言資料一樣，只是多一個 where 來顯示輸出的 id 留言資料。</p>
<br>
<p><strong>新增留言資料讀取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Message</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span>
</span></span><span class="line"><span class="cl">        <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 create 來新增資料，將 user_id 帶入傳值進來的 <code>$id</code>，content 帶入 <code>$content</code>。</p>
<br>
<p><strong>修改留言資料讀取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">updateMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Message</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="nv">$version</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先使用 where 來檢查樂觀鎖 version ，在查詢此 id 是否存在，以及編輯者是否為發文者，最後用 update 來更新資料表，分別更新 user_id、content、version(樂觀鎖每次加1) 等欄位。</p>
<br>
<p><strong>按讚留言資料讀取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">likeMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Like</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;message_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;user_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;created_at&#39;</span> <span class="o">=&gt;</span> <span class="nx">\Carbon\Carbon</span><span class="o">::</span><span class="na">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>按讚我們會在 like 的資料表中來新增紀錄，所以也是使用 create 來新增，新增 message_id、user_id、created_at 。</p>
<br>
<p><strong>刪除留言資料讀取</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">deleteMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Message</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>刪除功能因為我們使用軟刪除，所以不用顧慮 FK 外鍵，所以可以直接刪除 message。</p>
<br>
<h4 id="controller-1">Controller</h4>
<p>到這裡我們講完 <code>MessageRepository.php</code> 的內容了，那原本的 Controller 剩下什麼呢 !?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">App\Repositories\MessageRepository</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Auth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Validator</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我們在商業邏輯上會處理 Request 內容，以及使用 MessageRepository 來對資料庫做存取、Auth 取的登入者的資訊等等功能，所以要記得先把他引用進來歐。</p>
<br>
<p><strong>查詢留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 查詢全部的留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">MessageRepository</span><span class="o">::</span><span class="na">getAllMessage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 查詢id留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$message</span> <span class="o">=</span> <span class="nx">MessageRepository</span><span class="o">::</span><span class="na">getMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;找不到留言&#34;</span><span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><font color='red'>由於我們 MessageRepository 都只有單純與資料庫進行交握，所有的判斷以及回傳都會在 controller 來做處理</font>，<code>getAll()</code> 會使用到 <code>MessageRepository::getAllMessage()</code> 的查詢並回傳顯示查詢的資料。</p>
<p><code>get(id)</code> 會先用 MessageRepository::getMessage($id) 來檢查 id 是否存在，如果不存在就會回傳找不到留言 404 的 status code，如果存在就回傳存在變數 <code>message</code> 的 <code>MessageRepository::getMessage($id)</code> 資料。</p>
<br>
<p><strong>新增留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 新增留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Auth</span><span class="o">::</span><span class="na">user</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$rules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max:20&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(),</span> <span class="nv">$rules</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;沒有輸入內容或長度超過20個字元&#34;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">MessageRepository</span><span class="o">::</span><span class="na">createMessage</span><span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;新增紀錄成功&#34;</span><span class="p">],</span> <span class="mi">201</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我們先使用 <code>Auth::user()</code> 將登入的使用者資料存在 <code>$user</code> 中，在檢查輸入的 request 內容是否有超過 20 的字元，如果有就回傳內容長度超過20個字元 400。接著就用 MessageRepository::createMessage 將要新增的資料帶入，最後回傳新增紀錄成功 201 。</p>
<br>
<p><strong>修改留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 更新id留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Auth</span><span class="o">::</span><span class="na">user</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$message</span> <span class="o">=</span> <span class="nx">MessageRepository</span><span class="o">::</span><span class="na">getMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;找不到留言&#34;</span><span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$rules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max:20&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(),</span> <span class="nv">$rules</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;沒有輸入內容或長度超過20個字元&#34;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">MessageRepository</span><span class="o">::</span><span class="na">updateMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">,</span> <span class="nv">$message</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;更新留言失敗&#34;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;修改成功&#34;</span><span class="p">],</span> <span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一樣先把登入的使用者存入 <code>$user</code>，檢查是否有這個 id ，沒有就回傳找不到留言 404，接下來檢查輸入的內容長度，如果超過，就回傳內容長度超過20個字元 400，再檢查要修改留言的與留言者是不是同一個使用者，如果不是就回傳權限不正確 403，最後就將資料透過 <code>MessageRepository::updateMessage</code> 來做更新，並回傳修改成功 200。</p>
<br>
<p><strong>按讚留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 按讚id留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">like</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Auth</span><span class="o">::</span><span class="na">user</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">MessageRepository</span><span class="o">::</span><span class="na">getMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;找不到留言&#34;</span><span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">MessageRepository</span><span class="o">::</span><span class="na">likeMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;按讚成功&#34;</span><span class="p">],</span> <span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一樣先把登入的使用者存入 <code>$user</code>，先檢查是否有這個留言，沒有就回傳找不到留言 404，接著就使用 <code>MessageRepository::likeMessage</code> 來記錄按讚留言，並回傳按讚成功 404。</p>
<br>
<p><strong>刪除留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="c1">// 刪除id留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">delete</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Auth</span><span class="o">::</span><span class="na">user</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">MessageRepository</span><span class="o">::</span><span class="na">deleteMessage</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;找不到留言&#34;</span><span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s2">&#34;message&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;刪除成功,沒有返回任何內容&#34;</span><span class="p">],</span> <span class="mi">204</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一樣先把登入的使用者存入 <code>$user</code>，先檢查是否有這個留言，沒有就回傳找不到留言 404，在檢查文章權限，錯誤就回傳權限不正確 403，最後檢查是否有被按讚，有的話要先刪除 like 裡面的按讚紀錄，最後再刪除文章(所有的刪除，因為我們在 model 裡面有使用 softdelete 軟刪除，所以不會真的刪除，而是在欄位的 deleted_at 加入刪除時間，來讓查詢時以為他被刪除了！)</p>
<br>
<h3 id="postman-測試">Postman 測試</h3>
<p>那我們一樣來看一下 Postman 的測試，這邊只顯示需要登入才能使用的 API。</p>
<h4 id="登入">登入</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/login.png" title="/images/laravel-advanced/login.png" data-thumbnail="/images/laravel-advanced/login.png" data-sub-html="<h2>新增留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/login.png"
            data-srcset="/images/laravel-advanced/login.png, /images/laravel-advanced/login.png 1.5x, /images/laravel-advanced/login.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/login.png" width="600" />
    </a><figcaption class="image-caption">新增留言 成功</figcaption>
    </figure>
<br> 
<p>我們把帳號密碼放到 Body 來傳送，如果帳號密碼正確，就會顯示登入成功，並且在 Cookie 裡面的 laravel_session，可以用來判斷是否登入，以及登入的人是誰。</p>
<br> 
<h4 id="新增留言---成功">新增留言 - 成功</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/post-api-success.png" title="/images/laravel-advanced/post-api-success.png" data-thumbnail="/images/laravel-advanced/post-api-success.png" data-sub-html="<h2>新增留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/post-api-success.png"
            data-srcset="/images/laravel-advanced/post-api-success.png, /images/laravel-advanced/post-api-success.png 1.5x, /images/laravel-advanced/post-api-success.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/post-api-success.png" width="600" />
    </a><figcaption class="image-caption">新增留言 成功</figcaption>
    </figure>
<br> 
<p>新增留言成功，因為 <strong><font color='blue'>有登入，所以可以從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> 會顯示新增紀錄成功以及回應 201 Created</p>
<br>
<h4 id="新增留言---失敗">新增留言 - 失敗</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/post-api-error.png" title="/images/laravel-advanced/post-api-error.png" data-thumbnail="/images/laravel-advanced/post-api-error.png" data-sub-html="<h2>新增留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/post-api-error.png"
            data-srcset="/images/laravel-advanced/post-api-error.png, /images/laravel-advanced/post-api-error.png 1.5x, /images/laravel-advanced/post-api-error.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/post-api-error.png" width="600" />
    </a><figcaption class="image-caption">新增留言 失敗</figcaption>
    </figure>
<br> 
<p>新增留言失敗，因為 <strong><font color='red'>沒有登入，無法從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，所以會顯示用戶需要認證以及回應 401 Unauthorized</p>
<br>
<h4 id="修改留言---成功">修改留言 - 成功</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/put-api-success.png" title="/images/laravel-advanced/put-api-success" data-thumbnail="/images/laravel-advanced/put-api-success.png" data-sub-html="<h2>修改留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/put-api-success"
            data-srcset="/images/laravel-advanced/put-api-success.png, /images/laravel-advanced/put-api-success 1.5x, /images/laravel-advanced/put-api-success.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/put-api-success" width="600" />
    </a><figcaption class="image-caption">修改留言 成功</figcaption>
    </figure>
<br> 
<p>修改留言成功，因為 <strong><font color='blue'>有登入，所以可以從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，會顯示修改成功以及回應 200 OK</p>
<br>
<h4 id="修改留言---失敗---沒有登入">修改留言 - 失敗 - 沒有登入</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/put-api-error-1.png" title="/images/laravel-advanced/put-api-error-1.png" data-thumbnail="/images/laravel-advanced/put-api-error-1.png" data-sub-html="<h2>修改留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/put-api-error-1.png"
            data-srcset="/images/laravel-advanced/put-api-error-1.png, /images/laravel-advanced/put-api-error-1.png 1.5x, /images/laravel-advanced/put-api-error-1.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/put-api-error-1.png" width="600" />
    </a><figcaption class="image-caption">修改留言 失敗</figcaption>
    </figure>
<br> 
<p>修改留言失敗，因為 <strong><font color='red'>沒有登入，無法從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，會顯示用戶需要認證以及回應 401 Unauthorized</p>
<br>
<h4 id="修改留言---失敗---權限不足">修改留言 - 失敗 - 權限不足</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/put-api-error-2.png" title="/images/laravel-advanced/put-api-error-2.png" data-thumbnail="/images/laravel-advanced/put-api-error-2.png" data-sub-html="<h2>修改留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/put-api-error-2.png"
            data-srcset="/images/laravel-advanced/put-api-error-2.png, /images/laravel-advanced/put-api-error-2.png 1.5x, /images/laravel-advanced/put-api-error-2.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/put-api-error-2.png" width="600" />
    </a><figcaption class="image-caption">修改留言 失敗</figcaption>
    </figure>
<br> 
<p>修改留言失敗，雖然 <strong><font color='red'>有登入，但存在 Cookie 裡面的 laravel_session 不是當初的留言者</font></strong> ，會顯示權限不正確以及回應 403 Forbidden</p>
<br>
<h4 id="按讚留言---成功">按讚留言 - 成功</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/patch-api-success.png" title="/images/laravel-advanced/patch-api-success" data-thumbnail="/images/laravel-advanced/patch-api-success.png" data-sub-html="<h2>修改留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/patch-api-success"
            data-srcset="/images/laravel-advanced/patch-api-success.png, /images/laravel-advanced/patch-api-success 1.5x, /images/laravel-advanced/patch-api-success.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/patch-api-success" width="600" />
    </a><figcaption class="image-caption">修改留言 成功</figcaption>
    </figure>
<br> 
<p>按讚留言成功，因為 <strong><font color='blue'>有登入，所以可以從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，會顯示按讚成功以及回應 200 OK</p>
<br>
<h4 id="按讚留言---失敗---沒有登入">按讚留言 - 失敗 - 沒有登入</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/patch-api-error.png" title="/images/laravel-advanced/patch-api-error.png" data-thumbnail="/images/laravel-advanced/patch-api-error.png" data-sub-html="<h2>修改留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/patch-api-error.png"
            data-srcset="/images/laravel-advanced/patch-api-error.png, /images/laravel-advanced/patch-api-error.png 1.5x, /images/laravel-advanced/patch-api-error.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/patch-api-error.png" width="600" />
    </a><figcaption class="image-caption">修改留言 失敗</figcaption>
    </figure>
<br> 
<p>按讚留言失敗，因為 <strong><font color='red'>沒有登入，無法從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，會顯示用戶需要認證以及回應 401 Unauthorized</p>
<br>
<h4 id="刪除留言---成功">刪除留言 - 成功</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/delete-api-success.png" title="/images/laravel-advanced/delete-api-success.png" data-thumbnail="/images/laravel-advanced/delete-api-success.png" data-sub-html="<h2>刪除留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/delete-api-success.png"
            data-srcset="/images/laravel-advanced/delete-api-success.png, /images/laravel-advanced/delete-api-success.png 1.5x, /images/laravel-advanced/delete-api-success.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/delete-api-success.png" width="600" />
    </a><figcaption class="image-caption">刪除留言 成功</figcaption>
    </figure>
<br> 
<p>刪除留言成功，因為 <strong><font color='blue'>有登入，所以可以從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，不會顯示訊息但會回應 204 No Content</p>
<br>
<h4 id="刪除留言---失敗---沒有登入">刪除留言 - 失敗 - 沒有登入</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/delete-api-error-1.png" title="/images/laravel-advanced/delete-api-error-1.png" data-thumbnail="/images/laravel-advanced/delete-api-error-1.png" data-sub-html="<h2>刪除留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/delete-api-error-1.png"
            data-srcset="/images/laravel-advanced/delete-api-error-1.png, /images/laravel-advanced/delete-api-error-1.png 1.5x, /images/laravel-advanced/delete-api-error-1.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/delete-api-error-1.png" width="600" />
    </a><figcaption class="image-caption">刪除留言 失敗</figcaption>
    </figure>
<br> 
<p>刪除留言失敗，因為 <strong><font color='red'>沒有登入，無法從 Cookie 裡面的 laravel_session 來驗證是否登入</font></strong> ，會顯示用戶需要認證以及回應 401 Unauthorized</p>
<br>
<h4 id="刪除留言---失敗---權限不足">刪除留言 - 失敗 - 權限不足</h4>
<figure><a class="lightgallery" href="/images/laravel-advanced/delete-api-error-2.png" title="/images/laravel-advanced/delete-api-error-2.png" data-thumbnail="/images/laravel-advanced/delete-api-error-2.png" data-sub-html="<h2>刪除留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/laravel-advanced/delete-api-error-2.png"
            data-srcset="/images/laravel-advanced/delete-api-error-2.png, /images/laravel-advanced/delete-api-error-2.png 1.5x, /images/laravel-advanced/delete-api-error-2.png 2x"
            data-sizes="auto"
            alt="/images/laravel-advanced/delete-api-error-2.png" width="600" />
    </a><figcaption class="image-caption">刪除留言 失敗</figcaption>
    </figure>
<br> 
<p>刪除留言失敗，雖然 <strong><font color='red'>有輸入正確的 token ，但不是當初的留言者</font></strong> ，會顯示權限不正確以及回應 403 Forbidden</p>
<br>
<h2 id="參考資料">參考資料</h2>
<p><a href="https://www.itread01.com/content/1545012913.html" target="_blank" rel="noopener noreffer">Laravel Auth 自定義user 模型目錄結構</a></p>
<p><a href="https://ithelp.ithome.com.tw/articles/10220381" target="_blank" rel="noopener noreffer">user ( Model )</a></p>
<p><a href="https://laravel.com/docs/5.4/validation#form-request-validation" target="_blank" rel="noopener noreffer">Laravel Form Request Validation</a></p>
<p><a href="https://ithelp.ithome.com.tw/articles/10250237" target="_blank" rel="noopener noreffer">laravel Validation 驗證格式</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/php/">PHP</a>
                </span><span><a href="/tags/%E6%A1%86%E6%9E%B6/">框架</a>
                </span><span><a href="/tags/laravel/">Laravel</a>
                </span><span><a href="/tags/restful-api/">RESTful API</a>
                </span><span><a href="/tags/repository/">Repository</a>
                </span><span><a href="/tags/%E5%AF%A6%E4%BD%9C/">實作</a>
                </span><span><a href="/tags/%E4%BB%8B%E7%B4%B9/">介紹</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>更新於 2022-04-04&nbsp;<a class="git-hash" href="https://github.com/880831ian/blog/commit/4ec1dae28f535a82d233c11b4203ef3b3448e8a1" target="_blank" title="committed&nbsp;by&nbsp;PinYi(880831ian@gmail.com)&nbsp;4ec1dae2:&nbsp;# 修改 Laravel 進階">
                            <i class="fas fa-hashtag fa-fw"></i>4ec1dae2</a></span>
            </div><div class="post-info-mod"><span>
                            <a class="link-to-markdown" href="/laravel-advanced/index.md" target="_blank">閱讀原始文檔</a>
                        </span><span>
                        &nbsp;|&nbsp;
                        <a class="link-to-markdown" href="https://github.com/880831ian/blog/tree/main/content/posts/laravel-advanced/index.zh-tw.md" target="_blank">Improve Article</a>
                    </span></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://blog.pin-yi.me/laravel-advanced/" data-title="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)" data-hashtags="PHP,框架,Laravel,RESTful API,Repository,實作,介紹"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://blog.pin-yi.me/laravel-advanced/" data-hashtag="PHP"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://blog.pin-yi.me/laravel-advanced/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://blog.pin-yi.me/laravel-advanced/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://blog.pin-yi.me/laravel-advanced/" data-title="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://blog.pin-yi.me/laravel-advanced/" data-title="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="https://blog.pin-yi.me/laravel-advanced/" data-title="Laravel 進階 (內建會員系統、驗證 RESTful API 是否登入、使用 Repository 設計模式)"><i class="fab fa-skype fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/redis/" class="prev" rel="prev" title="Redis 介紹"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/docker/" class="next" rel="next" title="Docker 介紹 (如何使用 Docker-compose 建置 PHP&#43;MySQl&#43;Nginx 環境)">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div><div id="comments" class="single-card"><div id="disqus_thread"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">此 Blog 多數程式文章都是參考網路大神，加上自己的見解與實作內容編寫而成的筆記，若有侵權，請聯繫我。</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://pin-yi.me">PinYi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=1.0.1', { scope: '/' })
        .then(() => {
            console.info('PinYi 部落格\u00A0Service Worker Registered');
        }, err => console.error('PinYi 部落格\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('PinYi 部落格\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到頂部">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看評論">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/css/lightgallery.min.css"><script src="https://pin-yi.disqus.com/embed.js" defer></script><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.0/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/js/lightgallery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.3.0/dist/lg-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.1/sharer.min.js"></script><script>window.config={"code":{"copyTitle":"複製到剪貼板","maxShownLines":120},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"找不到你輸入的資料🥲","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body></html>
