<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet) - PinYi</title><meta name="description" content="此文章是介紹參考網路上 K8s 搭配 EFK 範例，自己實際測試後的紀錄，歡迎大家可以先閱讀原文，原文會放在文章最後，歡迎大家指教 😁"><meta property="og:title" content="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)" />
<meta property="og:description" content="此文章是介紹參考網路上 K8s 搭配 EFK 範例，自己實際測試後的紀錄，歡迎大家可以先閱讀原文，原文會放在文章最後，歡迎大家指教 😁" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pin-yi.me/k8s-efk/" /><meta property="og:image" content="https://pin-yi.me/k8s-efk/featured-image.webp"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-10T15:40:00+08:00" />
<meta property="article:modified_time" content="2022-05-17T16:32:21+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://pin-yi.me/k8s-efk/featured-image.webp"/>
<meta name="twitter:title" content="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)"/>
<meta name="twitter:description" content="此文章是介紹參考網路上 K8s 搭配 EFK 範例，自己實際測試後的紀錄，歡迎大家可以先閱讀原文，原文會放在文章最後，歡迎大家指教 😁"/>
<meta name="application-name" content="PinYi">
<meta name="apple-mobile-web-app-title" content="PinYi"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/avatar.webp"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://pin-yi.me/k8s-efk/" /><link rel="prev" href="https://pin-yi.me/k8s-advanced/" /><link rel="next" href="https://pin-yi.me/jenkins-ansible/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css">
        <link href="https://www.googletagmanager.com" rel="preconnect" crossorigin>
        <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)",
        "inLanguage": "zh-tw",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/pin-yi.me\/k8s-efk\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/pin-yi.me\/k8s-efk\/featured-image.webp",
                            "width":  1280 ,
                            "height":  300 
                        }],"genre": "posts","keywords": "Kubernetes, K8s, EFK, 實作","wordcount":  4662 ,
        "url": "https:\/\/pin-yi.me\/k8s-efk\/","datePublished": "2022-05-10T15:40:00+08:00","dateModified": "2022-05-17T16:32:21+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhuang,Pin-Yi","logo": "https:\/\/pin-yi.me\/images\/avatar.webp"},"author": {
                "@type": "Person",
                "name": "PinYi"
            },"description": "此文章是介紹參考網路上 K8s 搭配 EFK 範例，自己實際測試後的紀錄，歡迎大家可以先閱讀原文，原文會放在文章最後，歡迎大家指教 😁"
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EK8X0P9SDS"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-EK8X0P9SDS', { 'anonymize_ip': false });
}
</script>
</head><body data-header-desktop="fixed" data-header-mobile="fixed"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="PinYi">PinYi 小天地</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 分類 </a><a class="menu-item" href="/tags/"> 標籤 </a><a class="menu-item" href="/sideproject/"> 作品集 </a><a class="menu-item" href="/categories/youtube/"> YouTube 影片 </a><a class="menu-item" href="/about/"> 關於我 </a><span class="menu-item delimiter"></span><span class="menu-item language" title="選擇語言">繁體中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/k8s-efk/" selected>繁體中文</option></select>
                    </span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a class="menu-item" href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="PinYi">PinYi 小天地</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">分類</a><a class="menu-item" href="/tags/" title="">標籤</a><a class="menu-item" href="/sideproject/" title="">作品集</a><a class="menu-item" href="/categories/youtube/" title="">YouTube 影片</a><a class="menu-item" href="/about/" title="">關於我</a><div class="menu-item"><a href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a>
                <span>&nbsp;|&nbsp;</span><a href="javascript:void(0);" class="theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div><span class="menu-item language" title="選擇語言">繁體中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/k8s-efk/" selected>繁體中文</option></select>
                </span></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目錄</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/k8s-efk/featured-image.webp"
        data-srcset="/k8s-efk/featured-image.webp, /k8s-efk/featured-image.webp 1.5x, /k8s-efk/featured-image.webp 2x"
        data-sizes="auto"
        alt="/k8s-efk/featured-image.webp"
        title="此文章是介紹參考網路上 K8s 搭配 EFK 範例，自己實際測試後的紀錄，歡迎大家可以先閱讀原文，原文會放在文章最後，歡迎大家指教 😁" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://pin-yi.me" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>PinYi</a></span>&nbsp;<span class="post-category">出版於  <a href="/categories/codenotes/"><i class="far fa-folder fa-fw"></i>程式筆記</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-05-10">2022-05-10</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;約 4662 字</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;預計閱讀 10 分鐘</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>目錄</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#版本資訊">版本資訊</a></li>
    <li><a href="#實作">實作</a>
      <ul>
        <li><a href="#創建命名空間">創建命名空間</a></li>
        <li><a href="#創建-elasticsearch-statefulset">創建 Elasticsearch StatefulSet</a>
          <ul>
            <li><a href="#創建-headless-service">創建 Headless Service</a></li>
            <li><a href="#創建-statefulset">創建 StatefulSet</a></li>
          </ul>
        </li>
        <li><a href="#創建-kibana-deployment-service">創建 Kibana Deployment Service</a></li>
        <li><a href="#創建-fluentd-daemonset">創建 Fluentd DaemonSet</a>
          <ul>
            <li><a href="#創建-serviceaccount">創建 ServiceAccount</a></li>
            <li><a href="#創建-clusterrole">創建 ClusterRole</a></li>
            <li><a href="#創建-clusterrolebinding">創建 ClusterRoleBinding</a></li>
            <li><a href="#創建-daemonset">創建 DaemonSet</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#部署常見問題及解決辦法">部署常見問題及解決辦法</a></li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>這是我們 Kubernetes 文章的第三篇，此文章會紀錄我將 EFK 建在 Kubernetes 上面，最後也會統整實作過程中，可能會遇到的一些問題，讓大家在學習時，可以更有效率，不用 debug 到死 😎😎</p>
<br>
<p>那由於本文會直接帶入程式，觀念部分，可以先查看：</p>
<ul>
<li>Kubernetes : <a href="https://pin-yi.me/k8s/" target="_blank" rel="noopener noreffer">Kubernetes (K8s) 介紹 - 基本</a></li>
<li>kubernetes : <a href="https://pin-yi.me/k8s-advanced/" target="_blank" rel="noopener noreffer">Kubernetes (K8s) 介紹 - 進階 (Service、Ingress、StatefulSet、Deployment、ReplicaSet)</a></li>
<li>EFK : <a href="https://pin-yi.me/docker-compose-redis-sentinel-haproxy-efk/" target="_blank" rel="noopener noreffer">用 EFK 收集容器日誌 (HAProxy、Redis Sentinel、Docker-compose)</a></li>
</ul>
<br>
<p>此文章程式碼也會同步到 Github ，需要的也可以去查看歐！要記得先確定一下自己的版本 <a href="https://github.com/880831ian/Kubernetes-EFK" target="_blank" rel="noopener noreffer">Github 程式碼連結</a> 😆</p>
<h2 id="版本資訊">版本資訊</h2>
<ul>
<li>macOS：11.6</li>
<li>Minikube：v1.25.2</li>
<li>hyperkit：0.20200908</li>
<li>Kubectl：Client Version：v1.22.5、Server Version：v1.23.3</li>
<li>Elasticsearch：8.1.3</li>
<li>Fluentd：v1.14.6-debian-elasticsearch7-1.0</li>
<li>Kibana：8.1.3</li>
</ul>
<br>
<h2 id="實作">實作</h2>
<h3 id="創建命名空間">創建命名空間</h3>
<p>在我們開始之前，我們首先建立一個命名空間，我們會將 EFK 所有的工具都安裝在此。那我想創建一個名為 <code>kube-logging</code> 的 namespace，先查詢現有的命名空間是否有重複：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get namespaces
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>我們可以看到這些已經存在的 namespace ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NAME                   STATUS   AGE
</span></span><span class="line"><span class="cl">default                Active   92m
</span></span><span class="line"><span class="cl">kube-logging           Active   89m
</span></span><span class="line"><span class="cl">kube-node-lease        Active   92m
</span></span><span class="line"><span class="cl">kube-public            Active   92m
</span></span><span class="line"><span class="cl">kube-system            Active   92m
</span></span><span class="line"><span class="cl">kubernetes-dashboard   Active   92m
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>那要怎麼創建一個命名空間呢？先打開編輯器編輯名為 <code>kube-logging.yaml</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>完成後，使用 <code>apply</code> 來創建命名空間：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f kube-logging.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">namespace/kube-logging created
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>再使用 <code>kubectl get namespaces</code> 查看是否多了一個名為 <code>kube-logging</code> 的命名空間：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get namespaces
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                   STATUS   AGE
</span></span><span class="line"><span class="cl">default                Active   2m23s
</span></span><span class="line"><span class="cl">kube-logging           Active   88s
</span></span><span class="line"><span class="cl">kube-node-lease        Active   2m24s
</span></span><span class="line"><span class="cl">kube-public            Active   2m24s
</span></span><span class="line"><span class="cl">kube-system            Active   2m24s
</span></span><span class="line"><span class="cl">kubernetes-dashboard   Active   2m19s
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<h3 id="創建-elasticsearch-statefulset">創建 Elasticsearch StatefulSet</h3>
<p>我們已經創建好一個命名空間來放我們的 EFK，首先先部署副本數有 3 個的 Elasticsearch Pod。為什麼要使用 3 個 呢？使用 3 個 Elasticsearch Pod 是為了避免在高可用性、多節點叢集時出現錯誤，當其中一個 Elasticsearch Pod 故障，其他 2 個就會選舉後來接替，保證叢集可以繼續運行。</p>
<br>
<h4 id="創建-headless-service">創建 Headless Service</h4>
<p>我們先創建名為 <code>elasticsearch_svc.yaml</code> 的 yaml 檔，用來處理 service 的問題：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">inter-node</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們有創建一個命名空間，所以要先在 metadata 加入 namespace: kube-logging。記得要設定標籤，當我們將 Elasticsearch StatefulSet 與此 Service 關聯時，Service 會返回指向的帶有標籤的 Elasticsearch Pod。然後我們設置 <code>clusterIP: None</code> 定義該 Service 為 Headless Service。最後定義 Port 9200 為 REST API、Port 9300 為 Node 之間的通信。</p>
<br>
<p>一樣使用 <code>apply</code> 來建立 Service：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f elasticsearch-svc.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">service/elasticsearch created
</span></span></code></pre></td></tr></table>
</div>
</div><p>我們這次直接查看 minikube dashboard：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/service.png" title="/images/K8s-efk/service.png" data-thumbnail="/images/K8s-efk/service.png" data-sub-html="<h2>elasticsearch service</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/service.png"
            data-srcset="/images/K8s-efk/service.png, /images/K8s-efk/service.png 1.5x, /images/K8s-efk/service.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/service.png" width="1200" />
    </a><figcaption class="image-caption">elasticsearch service</figcaption>
    </figure>
<br>
<h4 id="創建-statefulset">創建 StatefulSet</h4>
<p>創建名為 <code>elasticsearch_statefulset.yaml</code> 的 yaml 檔案 (因為程式長度，所以分開說明，要完整請參考 <a href="https://github.com/880831ian/Kubernetes-EFK" target="_blank" rel="noopener noreffer">Github 程式碼連結</a>)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">es-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>名稱取名為 <code>es-cluster</code> ，我一樣使用 kube-logging 的 namespace，設定 ServiceName <code>elasticsearch</code> 是確保 StatefulSet 中的每一個 Pod 都可以使用以下 DNS 位址進行訪問：<code>es-cluster-[0,1,2].elasticsearch.kube-logging.svc.cluster.local</code> ，其中 <code>[0,1,2]</code> 對應 Pod 分配的整數序號。</p>
<p>我們指定副本數為 3，並將 <code>matchLabels</code> 選擇器設定 <code>app: elasticseach</code>，我們在將其鏡像到該 <code>.spec.template.metadata</code>，<code>.spec.selector.matchLabels</code> 跟 <code>.spec.template.metadata.labels</code> 必須相同。</p>
<br>
<p>接續&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch:8.1.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">inter-node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">discovery.seed_hosts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.initial_master_nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;es-cluster-0,es-cluster-1,es-cluster-2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ES_JAVA_OPTS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;-Xms512m -Xmx512m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xpack.security.enabled</span><span class="w"> </span><span class="c"># 記得要加上，因爲 Elasticsearch 8.x版本後會自動開啟SSL，如果沒有設定他就會一直重新啟動</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們定義容器名稱是 <code>elasticsearch</code>，映像檔是 <code>elasticsearch:8.1.3</code> ，要記得這個版本要與後面的 kibana 相同，我們在 resources 設置容器至少需要 0.1 CPU，最多可以到 1 個 CPU。一樣設定 Port 9200 為 REST API、Port 9300 為 Node 之間的通信，並將名為 <code>data</code> 的PersistentVolume 的容器掛載到容器的 <code>/usr/share/elasticsearch/data</code>。</p>
<p>最後幫容器設置一些環境變數：</p>
<ul>
<li><code>cluster.name</code>：Elasticsearch 叢集的名稱，我們設定為 <code>k8s-logs</code>。</li>
<li><code>node.name</code>：節點名稱，我們設置 valueFrom 使用 <code>.metadata.name</code>，它會解析為 <code>es-cluster-[0,1,2]</code>，取決節點的指定順序。</li>
<li><code>discovery.seed_hosts</code>：設置叢集中主節點列表，這些節點將會為節點發現過程中提供 Pod，但由於我們配置的 Headless Service，所以我們的 Pod 具有 <code>es-cluster-[0,1,2].elasticsearch.kube-logging.svc.cluster.local</code> Kubernetes DNS 解析。</li>
<li><code>cluster.initial_master_nodes</code>：這邊指定將參與主節點的選舉過程節點列表，這邊是通過節點 <code>node.name</code> 來辨識，不是透過主機名。</li>
<li><code>ES_JAVA_OPTS</code>：這邊我們設置 <code>-Xms512m -Xmx512m</code>，告訴 JVM 使用最大跟最小 512 MB，可以依據資源來做調配。</li>
<li><code>xpack.security.enabled</code>：這是也是我在 elasticsearch 卡很久的一個設定，詳細的會在最後的常見問題中提到，大家只要記得 elasticsearch 8.x 以後都需要多這個。</li>
</ul>
<br>
<p>接續&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fix-permissions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;chown -R 1000:1000 /usr/share/elasticsearch/data&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/share/elasticsearch/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">increase-vm-max-map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sysctl&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-w&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;vm.max_map_count=262144&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">increase-fd-ulimit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;ulimit -n 65536&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們這個區塊定義了主容器運行前的初始化設定：</p>
<ul>
<li><code>fix-permissions</code>：因為默認情況下，Kubernetes 會將數據目錄掛載為 <code>root</code>，導致 Elasticsearch 無法訪問，所以才會多這個運行 <code>chown</code> 將 Elasticsearch 數據目錄的所有者和組更改為 <code>1000:1000 /usr/share/elasticsearch/data</code>。詳細可以參考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#_notes_for_production_use_and_defaults" target="_blank" rel="noopener noreffer">Notes for Production Use and Defaults</a>。</li>
<li><code>increase-vm-max-map</code>：這邊是因為默認情況下內存會太低，所以多這個用 <code>sysctl -w</code> 來調整內存大小。詳細可以參考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html" target="_blank" rel="noopener noreffer">Elasticsearch documentation</a>。</li>
<li><code>iincrease-fd-ulimit</code>：它運行 <code>ulimit</code> 調整打開文件描述的最大數量。詳細可以參考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#_notes_for_production_use_and_defaults" target="_blank" rel="noopener noreffer">Notes for Production Use and Defaults</a>。</li>
</ul>
<br>
<p>接續&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ReadWriteOnce&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">3Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>這邊定義了 StatefulSet 的 <code>volumeClaimTemplates</code>。Kubernetes 會幫 Pod 創建 PersistentVolume，我們在上面的命名將它取為 <code>data</code>，並與 <code>app: elasticsearch</code>  StatefulSet 相同標籤。
我們將訪問的模式設定為 <code>ReadWriteOnce</code>，代表我們只能被單個節點以讀寫方式掛載，最後我們設定每個 PersistentVolume 的大小為 3GiB。</p>
<br>
<p>都完成後，我們一樣用 <code>apply</code> 部署 StatefulSet：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl apply -f elasticsearch-statefulset.yaml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">statefulset.apps/es-cluster created
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>我們可以查看 minikube dashboard：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/statefulset.png" title="/images/K8s-efk/statefulset.png" data-thumbnail="/images/K8s-efk/statefulset.png" data-sub-html="<h2>elasticsearch statefulset</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/statefulset.png"
            data-srcset="/images/K8s-efk/statefulset.png, /images/K8s-efk/statefulset.png 1.5x, /images/K8s-efk/statefulset.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/statefulset.png" width="1200" />
    </a><figcaption class="image-caption">elasticsearch statefulset</figcaption>
    </figure>
<br>
<p>可以看到已經成功建好，接著我們使用 port-forward 來測試是否正常運作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl port-forward es-cluster-0 9200:9200 --namespace=kube-logging
</span></span><span class="line"><span class="cl">$ curl http://localhost:9200/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;name&#34; : &#34;es-cluster-0&#34;,
</span></span><span class="line"><span class="cl">  &#34;cluster_name&#34; : &#34;k8s-logs&#34;,
</span></span><span class="line"><span class="cl">  &#34;cluster_uuid&#34; : &#34;aGxBystkQFW-xvjJ98Pxcw&#34;,
</span></span><span class="line"><span class="cl">  &#34;version&#34; : {
</span></span><span class="line"><span class="cl">    &#34;number&#34; : &#34;8.1.3&#34;,
</span></span><span class="line"><span class="cl">    &#34;build_flavor&#34; : &#34;default&#34;,
</span></span><span class="line"><span class="cl">    &#34;build_type&#34; : &#34;docker&#34;,
</span></span><span class="line"><span class="cl">    &#34;build_hash&#34; : &#34;39afaa3c0fe7db4869a161985e240bd7182d7a07&#34;,
</span></span><span class="line"><span class="cl">    &#34;build_date&#34; : &#34;2022-04-19T08:13:25.444693396Z&#34;,
</span></span><span class="line"><span class="cl">    &#34;build_snapshot&#34; : false,
</span></span><span class="line"><span class="cl">    &#34;lucene_version&#34; : &#34;9.0.0&#34;,
</span></span><span class="line"><span class="cl">    &#34;minimum_wire_compatibility_version&#34; : &#34;7.17.0&#34;,
</span></span><span class="line"><span class="cl">    &#34;minimum_index_compatibility_version&#34; : &#34;7.0.0&#34;
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl">  &#34;tagline&#34; : &#34;You Know, for Search&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果像我上面一樣有跳出 ”You Know, for Search“ 就代表 Elasticsearch 已經在正常運作囉 🥳</p>
<br>
<h3 id="創建-kibana-deployment-service">創建 Kibana Deployment Service</h3>
<p>要在 Kubernetes 上啟動 Kibana，我們要先創建一個名為 Service <code>kibana</code>，以及包含一個副本的 Deployment。我們先創建名為 kibana.yaml 的 yaml 檔：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5601</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kibana:8.1.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ELASTICSEARCH_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">http://elasticsearch:9200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">5601</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>一樣我們要把 <code>kibana</code> 加入 <code>kube-logging</code> 的命名空間，讓它以去調用其他服務，並賦予 <code>app: kibana</code> 標籤。並指定本機訪問 Port 為 <code>5601</code>，並使用 <code>app: kibana</code> 標籤來選擇服務的 Pod。我們在 <code>Deployment</code> 定義 1 個 Pod 副本，我們使用 <code>kibana:8.1.3</code> image，記得要跟 Elasticsearch 使用相同版本，此外我們還有設定 Pod 最少使用 0.1 個 CPU、最多使用 1 個 CPU。最後在環境變數中使用 <code>ELASTICSEARCH_URL</code> 設定 Elasticsearch 的叢集以及 Port。</p>
<br>
<p>都完成後，我們來開始部署：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f kibana.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">service/kibana created
</span></span><span class="line"><span class="cl">deployment.apps/kibana created
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>一樣我們用 minikube dashboard 來查看是否部署成功：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/kibana-1.png" title="/images/K8s-efk/kibana-1.png" data-thumbnail="/images/K8s-efk/kibana-1.png" data-sub-html="<h2>kibana Deployments</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/kibana-1.png"
            data-srcset="/images/K8s-efk/kibana-1.png, /images/K8s-efk/kibana-1.png 1.5x, /images/K8s-efk/kibana-1.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/kibana-1.png" width="1200" />
    </a><figcaption class="image-caption">kibana Deployments</figcaption>
    </figure>
<br>
<p>沒有問題後，我們用 <code>port-forward</code> 將本地 Port 轉發到 Pod 上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$  kubectl port-forward kibana-75cbbfcd9c-nr4r8 5601:5601 --namespace<span class="o">=</span>kube-logging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:5601 -&gt; <span class="m">5601</span>
</span></span><span class="line"><span class="cl">Forwarding from <span class="o">[</span>::1<span class="o">]</span>:5601 -&gt; <span class="m">5601</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">5601</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>開啟瀏覽器瀏覽 <code>http://localhost:5601</code>，如果可以進入 Kibana，就代表成功將 Kibana 部署到 Kubernetes 叢集中：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/kibana-2.png" title="/images/K8s-efk/kibana-2.png" data-thumbnail="/images/K8s-efk/kibana-2.png" data-sub-html="<h2>kibana Deployments</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/kibana-2.png"
            data-srcset="/images/K8s-efk/kibana-2.png, /images/K8s-efk/kibana-2.png 1.5x, /images/K8s-efk/kibana-2.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/kibana-2.png" width="1200" />
    </a><figcaption class="image-caption">kibana Deployments</figcaption>
    </figure>
<br>
<h3 id="創建-fluentd-daemonset">創建 Fluentd DaemonSet</h3>
<p>我們要將 Fluentd 設置成 DaemonSet，讓它在 Kubernetes 叢集中每個節點上運行 Pod 副本。用 DaemonSet 控制器，可以將叢集中每個節點部署 Fluentd Pod，詳細可以參考 <a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/#using-a-node-logging-agent" target="_blank" rel="noopener noreffer">Using a node logging agent</a>。在 Kubernetes 中，容器化的應用程式會透過 stdout 將日誌 log 定向到節點上的 JSON 文件。Fluentd Pod 會追蹤這些日誌文件、過濾日誌事件、轉換日誌的數據，並發送到我們部署的 Elasticsearch 後端。</p>
<p>除了容器的日誌，Fluentd 還會追蹤 Kubernetes 系統日誌，例如：kubelet、kube-proxy 和 Docker 日誌。</p>
<br>
<p>先創建一個 <code>fluentd.yaml</code> 的 yaml 檔 (因為程式長度，所以分開說明，要完整請參考 <a href="https://github.com/880831ian/Kubernetes-EFK" target="_blank" rel="noopener noreffer">Github 程式碼連結</a>)：</p>
<h4 id="創建-serviceaccount">創建 ServiceAccount</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們先創建一個服務帳號 <code>fluentd</code>，Fluentd Pod 將使用它來訪問 Kubernetes API。我們在 <code>kube-logging</code> namespace 中創建它並再次賦予它 label <code>app: fluentd</code>。</p>
<br>
<h4 id="創建-clusterrole">創建 ClusterRole</h4>
<p>接著&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在這邊我們定義一個 ClusterRole <code>fluentd</code>，設定我們對叢集範圍的 Kubernetes 資源（如節點）的訪問權限，我們設定 <code>get</code>、<code>list</code>、<code>watch</code> 等權限。</p>
<br>
<h4 id="創建-clusterrolebinding">創建 ClusterRoleBinding</h4>
<p>接著&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們定義一個將 ClusterRole 綁定到 ServiceAccount 的 ClusterRoleBinding 調用。</p>
<br>
<h4 id="創建-daemonset">創建 DaemonSet</h4>
<p>接著&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>定義一個可以在 <code>kube-logging</code> namespace 中調用的 DaemonSet，並給它一個 <code>app: fluentd</code> 標籤。</p>
<br>
<p>接著&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">fluentd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_HOST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;elasticsearch.kube-logging.svc.cluster.local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9200&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENT_ELASTICSEARCH_SCHEME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">FLUENTD_SYSTEMD_CONF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">disable</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們先匹配 <code>.metadata.labels</code> 定義的標籤 <code>app: fluentd</code> ，然後為 DaemonSet 分配 <code>fluentd</code> Service Account。選擇 <code>app: fluentd</code> 作為這個 DaemonSet 管理的 Pod。</p>
<p>我們定義 <code>NoSchedule</code> 容忍度來匹配 Kubernetes master node 上的等效污點。他可以確保 DaemonSet 也被部署到 Kubernetes 主服務器。</p>
<p>接下來定義 Pod 容器，我們將名稱取為 <code>fluentd</code>，我們使用的映像檔是 <a href="https://hub.docker.com/layers/fluentd-kubernetes-daemonset/fluent/fluentd-kubernetes-daemonset/v1.14.6-debian-elasticsearch7-1.0/images/sha256-9c960d2ebf6b8ba290bafd4ff386f26427a5469767b609e8735a3d983deb64b0?context=explore" target="_blank" rel="noopener noreffer">fluent/fluentd-kubernetes-daemonset:v1.14.6-debian-elasticsearch7-1.0</a>，最後配置一些環境變數：</p>
<ul>
<li><code>FLUENT_ELASTICSEARCH_HOST</code>：設置我們之前定義的 Elasticsearch Headless 位址。<code>elasticsearch.kube-logging.svc.cluster.local</code> 會解析 3 個 Elasticsearch Pod 的 IP 地址列表。</li>
<li><code>FLUENT_ELASTICSEARCH_PORT</code>：設置我們之前定義的 Elasticsearch <code>9200</code> Port。</li>
<li><code>FLUENT_ELASTICSEARCH_SCHEME</code>：我們設置 <code>http</code>。</li>
<li><code>FLUENTD_SYSTEMD_CONF</code>：我們將 <code>systemd</code> 在容器中設定相關的輸出設置為 <code>disable</code>。</li>
</ul>
<br>
<p>接著&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">512Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">200Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlibdockercontainers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlog</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">varlibdockercontainers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker/containers</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我們設置 Fluentd Pod 上使用 512 MiB 的內存限制，並保證 0.1 個 CPU 跟 200 MiB 的內存。我們將 varlog <code>/var/log</code> 以及 varlibdockercontainers <code>var/lib/docker/containers</code> 一併掛載進容器內。最後一個設定是 <code>Fluentd</code> 在收到信號 <code>terminationGracePeriodSeconds</code> 後有 30 秒的時間可以優雅的關閉。</p>
<br>
<p>都定義完成後，我們部署 Fluentd DaemonSet：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f fluentd.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">serviceaccount/fluentd created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/fluentd created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/fluentd created
</span></span><span class="line"><span class="cl">daemonset.apps/fluentd created
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>一樣我們用 minikube dashboard 來查看是否部署成功：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/Daemonset.png" title="/images/K8s-efk/Daemonset.png" data-thumbnail="/images/K8s-efk/Daemonset.png" data-sub-html="<h2>fluentd DaemonSet</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/Daemonset.png"
            data-srcset="/images/K8s-efk/Daemonset.png, /images/K8s-efk/Daemonset.png 1.5x, /images/K8s-efk/Daemonset.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/Daemonset.png" width="1200" />
    </a><figcaption class="image-caption">fluentd DaemonSet</figcaption>
    </figure>
<br>
<p>我們使用剛剛的 kibana <code>port-forward</code> 將本地 Port 轉發到 Pod 上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$  kubectl port-forward kibana-75cbbfcd9c-nr4r8 5601:5601 --namespace<span class="o">=</span>kube-logging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:5601 -&gt; <span class="m">5601</span>
</span></span><span class="line"><span class="cl">Forwarding from <span class="o">[</span>::1<span class="o">]</span>:5601 -&gt; <span class="m">5601</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">5601</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>開啟瀏覽器瀏覽 <code>http://localhost:5601</code>，點選 Management &gt; Stack Management：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/fluentd-1.png" title="/images/K8s-efk/fluentd-1.png" data-thumbnail="/images/K8s-efk/fluentd-1.png" data-sub-html="<h2>fluentd 設定</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/fluentd-1.png"
            data-srcset="/images/K8s-efk/fluentd-1.png, /images/K8s-efk/fluentd-1.png 1.5x, /images/K8s-efk/fluentd-1.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/fluentd-1.png" width="1200" />
    </a><figcaption class="image-caption">fluentd 設定</figcaption>
    </figure>
<br>
<p>點選 Kibana &gt; Data Views，會看到跳出一個視窗，有一個按鈕寫 Create data view：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/fluentd-2.png" title="/images/K8s-efk/fluentd-2.png" data-thumbnail="/images/K8s-efk/fluentd-2.png" data-sub-html="<h2>fluentd 設定</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/fluentd-2.png"
            data-srcset="/images/K8s-efk/fluentd-2.png, /images/K8s-efk/fluentd-2.png 1.5x, /images/K8s-efk/fluentd-2.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/fluentd-2.png" width="1200" />
    </a><figcaption class="image-caption">fluentd 設定</figcaption>
    </figure>
<br>
<p>Name 輸入 <code>logstash*</code> ，並選擇 <code>@timestamp</code> 來用時間過濾日誌，最後按下 Create date view：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/fluentd-3.png" title="/images/K8s-efk/fluentd-3.png" data-thumbnail="/images/K8s-efk/fluentd-3.png" data-sub-html="<h2>fluentd 設定</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/fluentd-3.png"
            data-srcset="/images/K8s-efk/fluentd-3.png, /images/K8s-efk/fluentd-3.png 1.5x, /images/K8s-efk/fluentd-3.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/fluentd-3.png" width="1200" />
    </a><figcaption class="image-caption">fluentd 設定</figcaption>
    </figure>
<br>
<p>設定好 logstash* 的 Data views，再點選左邊欄位的 Discover：</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/fluentd-4.png" title="/images/K8s-efk/fluentd-4.png" data-thumbnail="/images/K8s-efk/fluentd-4.png" data-sub-html="<h2>fluentd 設定</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/fluentd-4.png"
            data-srcset="/images/K8s-efk/fluentd-4.png, /images/K8s-efk/fluentd-4.png 1.5x, /images/K8s-efk/fluentd-4.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/fluentd-4.png" width="1200" />
    </a><figcaption class="image-caption">fluentd 設定</figcaption>
    </figure>
<br>
<p>就可以看到顯示容器的 log 日誌拉！</p>
<br>
<figure><a class="lightgallery" href="/images/K8s-efk/log.png" title="/images/K8s-efk/log.png" data-thumbnail="/images/K8s-efk/log.png" data-sub-html="<h2>顯示容器 log</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/K8s-efk/log.png"
            data-srcset="/images/K8s-efk/log.png, /images/K8s-efk/log.png 1.5x, /images/K8s-efk/log.png 2x"
            data-sizes="auto"
            alt="/images/K8s-efk/log.png" width="1200" />
    </a><figcaption class="image-caption">顯示容器 log</figcaption>
    </figure>
<br>
<h2 id="部署常見問題及解決辦法">部署常見問題及解決辦法</h2>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>常見問題<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Q1 . Elasticsearch 部署成功後會一直重新啟動？</div>
        </div>
    </div>
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw"></i>解決辦法<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Ans 1：原因是 Elasticsearch 從 8.x 版本後，會自動開啟 SSL 認證，我們在 <code>env</code> 環境變數設定時，如果沒有多加 SSL Key 等設定值，Elasticsearch  這個 Pod 會啟動後，一直重新啟動，導致服務無法正常使用，只需要在環境變數中加入 xpack.security.enabled ，設定為 false 就可以解決。</div>
        </div>
    </div>
<br>
<h2 id="參考資料">參考資料</h2>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes" target="_blank" rel="noopener noreffer">How To Set Up an Elasticsearch, Fluentd and Kibana (EFK) Logging Stack on Kubernetes</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/kubernetes/">Kubernetes</a>
                </span><span><a href="/tags/k8s/">K8s</a>
                </span><span><a href="/tags/efk/">EFK</a>
                </span><span><a href="/tags/%E5%AF%A6%E4%BD%9C/">實作</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>更新於 2022-05-17&nbsp;<a class="git-hash" href="https://github.com/880831ian/blog/commit/e25fc02edccda2ce4b1ad3f23004e4591e917cac" target="_blank" title="committed&nbsp;by&nbsp;ian_zhuang(880831ian@gmail.com)&nbsp;e25fc02:&nbsp;# 更新 Kubernetes (K8s) 搭配 EFK 實作">
                            <i class="fas fa-hashtag fa-fw"></i>e25fc02</a></span>
            </div><div class="post-info-mod"><span>
                            <a class="link-to-markdown" href="/k8s-efk/index.md" target="_blank">閱讀原始文檔</a>
                        </span><span>
                        &nbsp;|&nbsp;
                        <a class="link-to-markdown" href="https://github.com/880831ian/blog/tree/main/content/posts/K8s-EFK/index.zh-tw.md" target="_blank">Improve Article</a>
                    </span></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://pin-yi.me/k8s-efk/" data-title="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)" data-hashtags="Kubernetes,K8s,EFK,實作"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://pin-yi.me/k8s-efk/" data-hashtag="Kubernetes"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://pin-yi.me/k8s-efk/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://pin-yi.me/k8s-efk/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://pin-yi.me/k8s-efk/" data-title="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://pin-yi.me/k8s-efk/" data-title="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="https://pin-yi.me/k8s-efk/" data-title="Kubernetes (K8s) 搭配 EFK 實作 (Deployment、StatefulSet、DaemonSet)"><i class="fab fa-skype fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/k8s-advanced/" class="prev" rel="prev" title="Kubernetes (K8s) 介紹 - 進階 (Service、Ingress、StatefulSet、Deployment、ReplicaSet)"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/jenkins-ansible/" class="next" rel="next" title="Jenkins 及 Ansible IT 自動化 CI/CD 介紹">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div><div id="comments" class="single-card"><div id="disqus_thread"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://pin-yi.me">PinYi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=1.0.1', { scope: '/' })
        .then(() => {
            console.info('PinYi\u00A0Service Worker Registered');
        }, err => console.error('PinYi\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('PinYi\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到頂部">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看評論">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/css/lightgallery.min.css"><script src="https://pin-yi.disqus.com/embed.js" defer></script><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.0/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/js/lightgallery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.3.0/dist/lg-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.1/sharer.min.js"></script><script>window.config={"code":{"copyTitle":"複製到剪貼板","maxShownLines":120},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"找不到你輸入的資料🥲","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body></html>
