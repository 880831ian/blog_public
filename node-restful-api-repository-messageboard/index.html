<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件) - PinYi</title><meta name="description" content="這裡是關於一個菜鳥工程師斜槓Youtuber的小天地"><meta property="og:title" content="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)" />
<meta property="og:description" content="本文章是使用 Node.js 來寫一個 Repository Restful API 的留言板，並且會使用 express 以及 sequelize (使用 Mysql)套件。 建議可以先觀看 Node.js 介紹 文章來簡單學習 Node 語言。 範例程式連結 點我 😘" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pin-yi.me/node-restful-api-repository-messageboard/" /><meta property="og:image" content="https://pin-yi.me/node-restful-api-repository-messageboard/featured-image.webp"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-11T11:37:10+08:00" />
<meta property="article:modified_time" content="2022-04-11T15:54:48+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://pin-yi.me/node-restful-api-repository-messageboard/featured-image.webp"/>
<meta name="twitter:title" content="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)"/>
<meta name="twitter:description" content="本文章是使用 Node.js 來寫一個 Repository Restful API 的留言板，並且會使用 express 以及 sequelize (使用 Mysql)套件。 建議可以先觀看 Node.js 介紹 文章來簡單學習 Node 語言。 範例程式連結 點我 😘"/>
<meta name="application-name" content="PinYi">
<meta name="apple-mobile-web-app-title" content="PinYi"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/avatar.webp"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://pin-yi.me/node-restful-api-repository-messageboard/" /><link rel="prev" href="https://pin-yi.me/node/" /><link rel="next" href="https://pin-yi.me/git/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css">
        <link href="https://www.googletagmanager.com" rel="preconnect" crossorigin>
        <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)",
        "inLanguage": "zh-tw",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/pin-yi.me\/node-restful-api-repository-messageboard\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/pin-yi.me\/node-restful-api-repository-messageboard\/featured-image.webp",
                            "width":  1280 ,
                            "height":  300 
                        }],"genre": "posts","keywords": "Node.js, RESTful API, Mysql, Repository, 實作, 介紹","wordcount":  7458 ,
        "url": "https:\/\/pin-yi.me\/node-restful-api-repository-messageboard\/","datePublished": "2022-04-11T11:37:10+08:00","dateModified": "2022-04-11T15:54:48+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhuang,Pin-Yi","logo": "https:\/\/pin-yi.me\/images\/avatar.webp"},"author": {
                "@type": "Person",
                "name": "PinYi"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EK8X0P9SDS"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-EK8X0P9SDS', { 'anonymize_ip': false });
}
</script>
</head><body data-header-desktop="fixed" data-header-mobile="fixed"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="PinYi">PinYi 小天地</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 分類 </a><a class="menu-item" href="/tags/"> 標籤 </a><a class="menu-item" href="/sideproject/"> 作品集 </a><a class="menu-item" href="/categories/youtube/"> YouTube 影片 </a><a class="menu-item" href="/about/"> 關於我 </a><span class="menu-item delimiter"></span><span class="menu-item language" title="選擇語言">繁體中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/node-restful-api-repository-messageboard/" selected>繁體中文</option></select>
                    </span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a class="menu-item" href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a><a href="javascript:void(0);" class="menu-item theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="PinYi">PinYi 小天地</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="請輸入要搜尋的標題或是內容" id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜尋">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">分類</a><a class="menu-item" href="/tags/" title="">標籤</a><a class="menu-item" href="/sideproject/" title="">作品集</a><a class="menu-item" href="/categories/youtube/" title="">YouTube 影片</a><a class="menu-item" href="/about/" title="">關於我</a><div class="menu-item"><a href="/index.xml" title="RSS"><i class="fas fa-rss fa-fw" title="RSS"></i> </a>
                <span>&nbsp;|&nbsp;</span><a href="javascript:void(0);" class="theme-switch" title="切換主題">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div><span class="menu-item language" title="選擇語言">繁體中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/node-restful-api-repository-messageboard/" selected>繁體中文</option></select>
                </span></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目錄</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="enable"><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/node-restful-api-repository-messageboard/featured-image.webp"
        data-srcset="/node-restful-api-repository-messageboard/featured-image.webp, /node-restful-api-repository-messageboard/featured-image.webp 1.5x, /node-restful-api-repository-messageboard/featured-image.webp 2x"
        data-sizes="auto"
        alt="/node-restful-api-repository-messageboard/featured-image.webp"
        title="/node-restful-api-repository-messageboard/featured-image.webp" /></div><div class="single-card" data-image="true"><h2 class="single-title animated flipInX">用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://pin-yi.me" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>PinYi</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-04-11">2022-04-11</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;約 7458 字</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;預計閱讀 15 分鐘</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>目錄</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#實作">實作</a>
      <ul>
        <li><a href="#檔案結構">檔案結構</a></li>
        <li><a href="#config">config</a></li>
        <li><a href="#migrations">migrations</a></li>
        <li><a href="#appjs">app.js</a></li>
        <li><a href="#router">router</a></li>
        <li><a href="#middleware">middleware</a></li>
        <li><a href="#models">models</a>
          <ul>
            <li><a href="#indexjs">index.js</a></li>
            <li><a href="#userjs">user.js</a></li>
            <li><a href="#messagejs">message.js</a></li>
            <li><a href="#replyjs">reply.js</a></li>
          </ul>
        </li>
        <li><a href="#controllers">controllers</a>
          <ul>
            <li><a href="#authjs">auth.js</a></li>
            <li><a href="#messagejs-1">message.js</a></li>
            <li><a href="#replyjs-1">reply.js</a></li>
          </ul>
        </li>
        <li><a href="#repositories">repositories</a>
          <ul>
            <li><a href="#authjs-1">auth.js</a></li>
            <li><a href="#messagejs-2">message.js</a></li>
            <li><a href="#replyjs-2">reply.js</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#常用指令-sequelize-cli">常用指令 (sequelize-cli)</a></li>
    <li><a href="#postman-測試">Postman 測試</a>
      <ul>
        <li><a href="#註冊---成功">註冊 - 成功</a></li>
        <li><a href="#註冊---失敗無輸入">註冊 - 失敗(無輸入)</a></li>
        <li><a href="#註冊---失敗已經註冊過">註冊 - 失敗(已經註冊過)</a></li>
        <li><a href="#登入---成功">登入 - 成功</a></li>
        <li><a href="#登入---失敗">登入 - 失敗</a></li>
        <li><a href="#查詢全部留言---成功無資料">查詢全部留言 - 成功(無資料)</a></li>
        <li><a href="#查詢全部留言---成功有資料">查詢全部留言 - 成功(有資料)</a></li>
        <li><a href="#查詢id留言---成功">查詢{id}留言 - 成功</a></li>
        <li><a href="#查詢id留言---失敗">查詢{id}留言 - 失敗</a></li>
        <li><a href="#新增留言---成功">新增留言 - 成功</a></li>
        <li><a href="#新增留言---失敗">新增留言 - 失敗</a></li>
        <li><a href="#修改id留言---成功">修改{id}留言 - 成功</a></li>
        <li><a href="#修改id留言---失敗">修改{id}留言 - 失敗</a></li>
        <li><a href="#刪除id留言---成功">刪除{id}留言 - 成功</a></li>
        <li><a href="#刪除id留言---失敗">刪除{id}留言 - 失敗</a></li>
        <li><a href="#新增回覆---成功">新增回覆 - 成功</a></li>
        <li><a href="#新增回覆---失敗">新增回覆 - 失敗</a></li>
        <li><a href="#修改id回覆---成功">修改{id}回覆 - 成功</a></li>
        <li><a href="#修改id回覆---失敗">修改{id}回覆 - 失敗</a></li>
        <li><a href="#刪除id回覆---成功">刪除{id}回覆 - 成功</a></li>
        <li><a href="#刪除id回覆---失敗">刪除{id}回覆 - 失敗</a></li>
      </ul>
    </li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><p>本文章是使用 Node.js 來寫一個 Repository Restful API 的留言板，並且會使用 express 以及 sequelize (使用 Mysql)套件。</p>
<p>建議可以先觀看 <a href="https://pin-yi.me/node/" target="_blank" rel="noopener noreffer">Node.js 介紹</a> 文章來簡單學習 Node 語言。</p>
<p><a href="https://github.com/880831ian/node-restful-api-repository-messageboard" target="_blank" rel="noopener noreffer">範例程式連結 點我 😘
</a></p>
<p>版本資訊</p>
<ul>
<li>macOS：11.6</li>
<li>node：v16.14.2</li>
<li>npm：8.5.0</li>
<li>Mysql：mysql  Ver 8.0.28 for macos11.6 on x86_64 (Homebrew)
<br></li>
</ul>
<h2 id="實作">實作</h2>
<h3 id="檔案結構">檔案結構</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── app.js
</span></span><span class="line"><span class="cl">├── config
</span></span><span class="line"><span class="cl">│   └── config.json
</span></span><span class="line"><span class="cl">├── controllers
</span></span><span class="line"><span class="cl">│   ├── auth.js
</span></span><span class="line"><span class="cl">│   ├── message.js
</span></span><span class="line"><span class="cl">│   └── reply.js
</span></span><span class="line"><span class="cl">├── middleware
</span></span><span class="line"><span class="cl">│   └── index.js
</span></span><span class="line"><span class="cl">├── migrations
</span></span><span class="line"><span class="cl">│   ├── 20220331054531-create-user.js
</span></span><span class="line"><span class="cl">│   ├── 20220401093019-create-message.js
</span></span><span class="line"><span class="cl">│   └── 20220404041905-create-reply.js
</span></span><span class="line"><span class="cl">├── models
</span></span><span class="line"><span class="cl">│   ├── index.js
</span></span><span class="line"><span class="cl">│   ├── message.js
</span></span><span class="line"><span class="cl">│   ├── reply.js
</span></span><span class="line"><span class="cl">│   └── user.js
</span></span><span class="line"><span class="cl">├── node_modules(以下檔案省略)
</span></span><span class="line"><span class="cl">├── package-lock.json
</span></span><span class="line"><span class="cl">├── package.json
</span></span><span class="line"><span class="cl">├── repositories
</span></span><span class="line"><span class="cl">│   ├── auth.js
</span></span><span class="line"><span class="cl">│   ├── message.js
</span></span><span class="line"><span class="cl">│   └── reply.js
</span></span><span class="line"><span class="cl">└── router
</span></span><span class="line"><span class="cl">    └── index.js
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<p>我們來說明一下上面的資料夾以及檔案各別功能與作用</p>
<ul>
<li>app.js：程式的啟動入口，裡面會放置有關程式系統需要呼叫哪些套件等等。</li>
<li>config：放置資料庫連線資料 (使用 sequelize-cli 套件自動產生)。</li>
<li>controllers：商用邏輯控制。</li>
<li>middleware：用來檢查登入權限。</li>
<li>migrations：放置產生不同 Model 資料表 (使用 sequelize-cli 套件自動產生)。</li>
<li>models：定義資料表資料型態 (使用 sequelize-cli 套件自動產生)。</li>
<li>node_modules：放置下載使用的套件位置。</li>
<li>package.json/package-lock.json：專案資訊的重要檔案 (使用 <code>npm init</code> 自動產生)。</li>
<li>repositories：處理與資料庫進行交握。</li>
<li>router：設定網站網址路由。</li>
</ul>
<br>
<p>以下詳細說明部分，只會說明 app.js、config、controllers、middleware、migrations、models、repositories、router (介紹會依照程式流程來介紹)。</p>
<br>
<h3 id="config">config</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;development&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;database&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialect&#34;</span><span class="p">:</span> <span class="s2">&#34;mysql&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialectOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;dateStrings&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typeCast&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timezone&#34;</span><span class="p">:</span> <span class="s2">&#34;+08:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;test&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;database&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialect&#34;</span><span class="p">:</span> <span class="s2">&#34;mysql&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialectOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;dateStrings&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typeCast&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timezone&#34;</span><span class="p">:</span> <span class="s2">&#34;+08:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;production&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;database&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialect&#34;</span><span class="p">:</span> <span class="s2">&#34;mysql&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dialectOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;dateStrings&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typeCast&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;timezone&#34;</span><span class="p">:</span> <span class="s2">&#34;+08:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由 sequelize-cli 套件自動產生，可以依照不同程式狀態(開發 development、測試 test、上線 production)來修改連線時的參數。</p>
<br>
<h3 id="migrations">migrations</h3>
<p>檔案基本上都雷同，舉其中一個為說明。migrations 也是由 sequelize-cli 套件自動產生，相關指令會統一放在最後。</p>
<ul>
<li>20220401093019-create-message.js</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="l">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">module.exports = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">async up(queryInterface, Sequelize) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">await queryInterface.createTable(&#34;message&#34;, {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">autoIncrement</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.INTEGER,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">user_id</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.INTEGER,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">references</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;user&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;id&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.STRING,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.INTEGER,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">defaultValue</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">createdAt</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.DATE,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">updatedAt</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.DATE,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">deletedAt</span><span class="p">:</span><span class="w"> </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">allowNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Sequelize.DATE,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="l">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">async down(queryInterface, Sequelize) {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">await queryInterface.dropTable(&#34;message&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="l">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>這個檔案的格式也是透過指令產生，會有 up 跟 down，up 就是執行指令後會產生什麼，主要都會是新增資料表或是修改資料表，down 則是回復的功能，可以將資料表給 dropTable 。我們主要會修改的地方是 createTable 內的資料，裡面的資料代表資料表的欄位，以下列出常用的格式：</p>
<ul>
<li>allowNull：是否為空值</li>
<li>autoIncrement：自動累加</li>
<li>primaryKey：主鍵</li>
<li>type：裡面就放欄位類型，例如 INTEGER、STRING、DATE等等</li>
</ul>
<h3 id="appjs">app.js</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;express&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;express-session&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">8888</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 設定 Session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">oneDay</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sessions</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">secret</span><span class="o">:</span> <span class="s2">&#34;mySecret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">saveUninitialized</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rolling</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cookie</span><span class="o">:</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">oneDay</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resave</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 註冊路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/api/v1&#34;</span><span class="p">,</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;./router&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 檢查是否有table，沒有就建立
</span></span></span><span class="line"><span class="cl"><span class="c1">// const Message = require(&#34;./models&#34;).message;
</span></span></span><span class="line"><span class="cl"><span class="c1">// const User = require(&#34;./models&#34;).user;
</span></span></span><span class="line"><span class="cl"><span class="c1">// Message.sync();
</span></span></span><span class="line"><span class="cl"><span class="c1">// User.sync();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 開啟監聽
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;啟動 Server,Port:&#34;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>先引入會使用的套件 (express：node web 框架、express-session：session 套件)</li>
<li>設定 app 為 express() 實例，port 為 8888。</li>
<li>設定 session 失效時間、名稱等設定。
<ul>
<li>secret(必要)：用來簽章 sessionID 的cookie, 可以是一secret字串或是多個secret組成的一個陣列。</li>
<li>name：在response中，設定的 sessionID cookie 名字。預設是 connect.sid。</li>
<li>saveUninitialized：強制將未初始化的session存回 session store，未初始化的意思是它是新的而且未被修改。</li>
<li>rolling：強制在每一次回應時，重新設置一個sessionID cookie。</li>
<li>cookie：設定sessionID 的cookie相關選項。</li>
<li>resave：強制將session存回 session store, 即使它沒有被修改。</li>
</ul>
</li>
<li>註冊路由，連線 <code>http://127.0.0.1/api/v1</code> 後面會導向 router 檔案。</li>
<li>註解部分為可以每次啟動後先檢查是否有table，沒有就建立。</li>
<li>開啟 port(8888) 監聽。</li>
</ol>
<br>
<h3 id="router">router</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;express&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../middleware&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">register</span><span class="p">,</span> <span class="nx">login</span><span class="p">,</span> <span class="nx">lojsut</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../controllers/auth&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getAllMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">updateMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">deleteMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../controllers/message&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">createReply</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">updateReply</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">deleteReply</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../controllers/reply&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 註冊、登入、登出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/register&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">register</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/login&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">login</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/lojsut&#34;</span><span class="p">,</span> <span class="nx">lojsut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查詢留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;/message&#34;</span><span class="p">,</span> <span class="nx">getAllMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;/message/:message_id&#34;</span><span class="p">,</span> <span class="nx">getMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//需要驗證才可以使用（新增留言、修改留言、刪除留言、新增留言回覆、修改留言回覆、刪除留言回覆）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/message&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">createMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s2">&#34;/message/:message_id&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">updateMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&#34;/message/:message_id&#34;</span><span class="p">,</span> <span class="nx">deleteMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/message/:message_id&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">createReply</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s2">&#34;/message/:message_id/:reply_id&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span> <span class="nx">updateReply</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">&#34;/message/:message_id/:reply_id&#34;</span><span class="p">,</span> <span class="nx">deleteReply</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定路由，分別是註冊、登入、登出、新增留言、查詢全部留言、查詢 {id} 留言、修改 {id} 留言、刪除 {id} 留言，連接到不同的 controller function。express.json() 函數是為了要讓 body-parser 解析帶有 JSON 傳入後面的 controller，其中比較特別的是因為新增留言、修改留言、刪除留言、新增留言回覆、修改留言回覆、刪除留言回覆需要登入後才可以使用，所以多一個 middleware 來驗證是否登入。</p>
<br>
<h3 id="middleware">middleware</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;用戶需要認證&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 session 來驗證是否有登入。</p>
<br>
<h3 id="models">models</h3>
<p>會放置與資料表資料型態有關的資訊，其中 index.js 是由 sequelize-cli 套件自動產生，用來讀取目前寫在 config 的連線設定檔等資訊。</p>
<h4 id="indexjs">index.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;fs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;sequelize&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">basename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="s2">&#34;development&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s2">&#34;/../config/config.json&#34;</span><span class="p">)[</span><span class="nx">env</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">sequelize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">use_env_variable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">use_env_variable</span><span class="p">],</span> <span class="nx">config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">database</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">file</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">file</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">file</span> <span class="o">!==</span> <span class="nx">basename</span> <span class="o">&amp;&amp;</span> <span class="nx">file</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&#34;.js&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">file</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">file</span><span class="p">))(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sequelize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">DataTypes</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">db</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">modelName</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">db</span><span class="p">[</span><span class="nx">modelName</span><span class="p">].</span><span class="nx">associate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">[</span><span class="nx">modelName</span><span class="p">].</span><span class="nx">associate</span><span class="p">(</span><span class="nx">db</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">sequelize</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">Sequelize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">db</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br>
<h4 id="userjs">user.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">Model</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;sequelize&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">user</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">static</span> <span class="nx">associate</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">user</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">foreignKey</span><span class="o">:</span> <span class="s2">&#34;user_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">user</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">username</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sequelize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">paranoid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">freezeTableName</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">modelName</span><span class="o">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此為 user 資料表的欄位資料，有預設的 init 初始化，比較特別的是如果有用到關聯性的外鍵等等要記得在 associate 做設定，<code>user.hasMany(models.message,{foreignKey: &quot;user_id&quot;,})</code> 代表 user 這張表可以有很多個 message，其 message 外鍵是 user_id。</p>
<ul>
<li>paranoid：代表會執行軟刪除而不是硬刪除，但必須要多一個 <code>deletedAt</code> 來存放軟刪除時間。</li>
<li>freezeTableName：因為 sequelize 會自動再產生資料表時加上複數，如果不想要就必須使用它讓 sequelize 不會自動加入 s (複數)。</li>
<li>modelName：此 model 名稱。</li>
</ul>
<br>
<h4 id="messagejs">message.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">Model</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;sequelize&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">message</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">static</span> <span class="nx">associate</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">message</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">reply</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">foreignKey</span><span class="o">:</span> <span class="s2">&#34;message_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="nx">message</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">foreignKey</span><span class="o">:</span> <span class="s2">&#34;user_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">message</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">user_id</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allowNull</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allowNull</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">version</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sequelize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">paranoid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">freezeTableName</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">modelName</span><span class="o">:</span> <span class="s2">&#34;message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此為 message 資料表的欄位資料，associate 設定有 <code>message.hasMany(models.reply,{foreignKey: &quot;message_id&quot;,})</code> 代表 message 這張表可以有很多個 reply，其 reply 外鍵是 message_id。以及 <code>message.belongsTo(models.user, {foreignKey: &quot;user_id&quot;,});</code> 代表 message 存在一對一的關係，外鍵是 user_id。</p>
<br>
<h4 id="replyjs">reply.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">Model</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;sequelize&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sequelize</span><span class="p">,</span> <span class="nx">DataTypes</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">reply</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">static</span> <span class="nx">associate</span><span class="p">(</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">foreignKey</span><span class="o">:</span> <span class="s2">&#34;message_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">foreignKey</span><span class="o">:</span> <span class="s2">&#34;user_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">reply</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">message_id</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allowNull</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">user_id</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">INTEGER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allowNull</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allowNull</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">version</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="nx">DataTypes</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sequelize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">paranoid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">freezeTableName</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">modelName</span><span class="o">:</span> <span class="s2">&#34;reply&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">reply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此為 reply 資料表的欄位資料，associate 設定有<code>reply.belongsTo(models.message, {foreignKey: &quot;message_id&quot;,});</code> 代表 reply 存在一對一的關係，外鍵是 message_id，以及 <code>reply.belongsTo(models.user, {foreignKey: &quot;user_id&quot;,});</code> 代表 reply 存在一對一的關係，外鍵是 user_id。</p>
<br>
<h3 id="controllers">controllers</h3>
<p>我們遵循 MVC 的設計規範，所有的商用邏輯都會放在 controller 內，repository 只負責與資料庫進行交握。</p>
<h4 id="authjs">auth.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../repositories/auth&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;bcrypt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 註冊
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">register</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;沒有正確輸入帳號或密碼&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSalt</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">bcrypt_password</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">bcrypt_password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;username已存在&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 登入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;沒有正確輸入帳號或密碼&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;帳號或密碼錯誤&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">session</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">session</span><span class="p">.</span><span class="nx">userid</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;登入成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 登出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">logout</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">session</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">user</span><span class="o">:</span> <span class="s2">&#34;登出成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">register</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">login</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>主要有3 個部份，註冊、登入、登出：</p>
<ul>
<li>註冊：會先驗證是否正確輸入資料(包含欄位是否錯誤等)，如果有錯，就會回應 400 以及沒有正確輸入帳號或密碼。接下來會使用到 <code>bcrypt</code> 來幫密碼進行加密處理，再把加密後的密碼以及帳號丟到 Auth.register repository 來進行資料庫的存取，如果錯誤會回應 400 以及 username 已存在，成功會回應 201 以及新增的帳號資訊。</li>
<li>登入：一樣會先檢查輸入資料，接著把資料丟到 Auth.login repository 來進行資料庫的驗證，如果錯誤會回應 400 以及帳號或密碼錯誤，成功會回應 200 以及登出成功。</li>
<li>登出：將 session 給清除，然後回應 200 以及登出成功。</li>
</ul>
<br>
<h4 id="messagejs-1">message.js</h4>
<p>(由於內容較多，所以依照功能拆分後說明)</p>
<p><strong>查詢留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../repositories/message&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Reply</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../repositories/reply&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 查詢所有留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">getAllMessage</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">message</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">getAll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//查詢{id}留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">getMessage</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">message</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;找不到留言&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先載入要使用的 repository ，查詢所有留言會使用 Message.getAll() repository 來進行資料庫的讀取，會回應 200 以及查詢內容，若是尚未有留言則會顯示空陣列。查詢{id}留言會將 <code>req.params.message_id</code> 丟到 Message.get repository 來進行資料庫的讀取，如果錯誤會回應 404 以及 找不到留言，成功會回應 200 以及查詢內容。</p>
<br>
<p><strong>新增留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//新增留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">createMessage</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;沒有輸入內容或長度超過20個字元&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">message</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>新增留言會先檢查輸入內容是否為空以及不能大於20個字元，如果錯誤就回應 400 以及沒有輸入內容或長度超過20個字元，再將 <code>req.session.userid</code>、<code>req.body.content</code> 丟到 Message.create repository 來進行資料庫的存取，成功會回應 201 以及新增的留言。</p>
<br>
<p><strong>修改留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//修改留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">updateMessage</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">message</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;找不到留言&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;沒有輸入內容或長度超過20個字元&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">message</span><span class="p">[</span><span class="s2">&#34;version&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">))</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;修改留言失敗&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;修改留言成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改留言因為需要先從資料中取得 <code>version</code> 來檢查樂觀鎖，所以會先將 <code>req.params.message_id</code> 丟到 Message.get repository 來進行資料庫的查詢，錯誤會回應 404 以及找不到留言。
先檢查輸入內容是否為空以及不能大於20個字元，如果錯誤就回應 400 以及沒有輸入內容或長度超過20個字元，再將 <code>req.params.message_id</code>、<code>req.session.userid</code>、<code>req.body.content</code>、<code>message[&quot;version&quot;]</code> 丟到 Message.update repository 來進行資料庫的更新，錯誤會回應 400 以及修改留言失敗，成功會回應 200 以及修改留言成功。</p>
<br>
<p><strong>刪除留言功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//刪除留言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">deleteMessage</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;刪除留言失敗&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 刪除留言時同步刪除所有回覆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">deleteMessage</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;刪除留言成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>刪除留言會將 <code>req.params.message_id</code>、<code>req.session.userid</code> 丟到 Message.delete repository 來進行資料庫的軟刪除，錯誤會回應 400 以及刪除留言失敗，因為我們刪除留言後，不能在對該留言進行回覆的任何功能，所以一同軟刪除所有的回覆，成功後會回應 204 以及刪除留言成功。</p>
<br>
<h4 id="replyjs-1">reply.js</h4>
<p>(由於內容較多，所以依照功能拆分後說明)</p>
<p><strong>新增回覆功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Reply</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../repositories/reply&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//新增回覆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">createReply</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;沒有輸入回覆或長度超過20個字元&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="p">(</span><span class="nx">reply</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span>
</span></span><span class="line"><span class="cl">    <span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;新增回覆失敗&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">reply</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先載入要使用的 repository，新增回覆先檢查輸入內容是否為空以及不能大於20個字元，如果錯誤就回應 400 以及沒有輸入內容或長度超過20個字元，再將 <code>req.params.message_id</code>、<code>req.session.userid</code>、<code>req.body.content</code> 丟到 Reply.create repository 來進行資料庫的存取，錯誤會回應 400 以及新增留言失敗，成功會回應 201 以及新增回覆內容。</p>
<br>
<p><strong>修改回覆功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//修改回覆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">updateReply</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">reply</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">reply_id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;找不到回覆&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;沒有輸入回覆或長度超過20個字元&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">reply_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">[</span><span class="s2">&#34;version&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">))</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;修改回覆失敗&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;修改回覆成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改留言因為需要先從資料中取得 <code>version</code> 來檢查樂觀鎖，所以會先將 <code>req.params.reply_id</code>、<code>req.params.message_id</code> 丟到 Reply.get repository 來進行資料庫的查詢，錯誤會回應 404 以及找不到留言。
先檢查輸入內容是否為空以及不能大於20個字元，如果錯誤就回應 400 以及沒有輸入內容或長度超過20個字元，再將 <code>req.params.reply_id </code>、<code>req.params.message_id</code>、<code>req.session.userid</code>、<code>req.body.content</code>、<code>reply[&quot;version&quot;]</code> 丟到 Reply.update repository 來進行資料庫的更新，錯誤會回應 400 以及修改回覆失敗，成功會回應 200 以及修改回覆成功。</p>
<br>
<p><strong>刪除回覆功能</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//刪除回覆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">deleteReply</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="p">(</span><span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">reply_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span>
</span></span><span class="line"><span class="cl">    <span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;刪除回覆失敗&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;刪除回覆成功&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>刪除回覆會將 <code>req.params.reply_id</code>、<code>req.params.message_id</code>、<code>req.session.userid</code> 丟到 Reply.delete repository 來進行資料庫的軟刪除，錯誤會回應 400 以及刪除回覆失敗，成功後會回應 204 以及刪除回覆成功。</p>
<br>
<h3 id="repositories">repositories</h3>
<p>此會放置與資料庫進行交握的程式。</p>
<h4 id="authjs-1">auth.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../models&#34;</span><span class="p">).</span><span class="nx">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;bcrypt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 註冊
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">async</span> <span class="nx">register</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">bcrypt_password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">username</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">bcrypt_password</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 登入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">async</span> <span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">username</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">))</span> <span class="o">?</span> <span class="nx">user</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">auth</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>auth 內主要有兩個與資料庫進行互動，分別是，註冊以及登入，註冊會將傳入的帳號以及加密過後密碼使用 <code>User.findOrCreate</code> 來進行查詢或新增，如果帳號不存在才會進行新增動作。登入會將傳入的帳號及密碼使用 <code>User.findOne</code> 來檢查是否存在，如果存在再檢查密碼與資料庫是否正確。</p>
<br>
<h4 id="messagejs-2">message.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../models&#34;</span><span class="p">).</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Reply</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../models&#34;</span><span class="p">).</span><span class="nx">reply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">getAll</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span> <span class="nx">include</span><span class="o">:</span> <span class="p">{</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">Reply</span> <span class="p">}</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">get</span><span class="p">(</span><span class="nx">message_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">include</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">model</span><span class="o">:</span> <span class="nx">Reply</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">message_id</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">user_id</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">update</span><span class="p">(</span><span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">version</span><span class="o">:</span> <span class="nx">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">version</span><span class="o">:</span> <span class="nx">version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="k">delete</span><span class="p">(</span><span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">repository</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>message.js 裡面有會查詢全部留言、查詢{id}留言、新增留言、修改{id}留言、刪除{id}留言等，以下會說明各別負責功用：</p>
<ul>
<li>查詢全部留言 getAll()：使用 <code>Message.findAll</code> 來顯示查詢結果，並且 include model Reply 回覆內容。</li>
<li>查詢{id}留言 get()：使用 <code>Message.findOne</code> 查詢 message.id 等於 message_id 的結果，並且 include model Reply 回覆內容。</li>
<li>新增留言 create()：使用 <code>Message.create</code> 新增 message.user_id 以及 message.content。</li>
<li>修改{id}留言 update()：使用 <code>Message.update</code> 更新 content 以及 version，且 message.id 要等於 message_id 及 message.user_id 等於 user_id 及 message.version 等於 version。</li>
<li>刪除{id}留言 delete()：使用 <code>Message.destroy</code> 刪除符合 message.id 等於 message_id 及 message.user_id 等於 user_id。
<br></li>
</ul>
<h4 id="replyjs-2">reply.js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Message</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../models&#34;</span><span class="p">).</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">Reply</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../models&#34;</span><span class="p">).</span><span class="nx">reply</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">reply</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">get</span><span class="p">(</span><span class="nx">reply_id</span><span class="p">,</span> <span class="nx">message_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">reply_id</span><span class="p">,</span> <span class="nx">message_id</span><span class="o">:</span> <span class="nx">message_id</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">is_exist</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">message_id</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_exist</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message_id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">update</span><span class="p">(</span><span class="nx">reply_id</span><span class="p">,</span> <span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">version</span><span class="o">:</span> <span class="nx">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">id</span><span class="o">:</span> <span class="nx">reply_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">message_id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">version</span><span class="o">:</span> <span class="nx">version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="k">delete</span><span class="p">(</span><span class="nx">reply_id</span><span class="p">,</span> <span class="nx">message_id</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="o">:</span> <span class="nx">reply_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message_id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">user_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">deleteMessage</span><span class="p">(</span><span class="nx">message_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kr">await</span> <span class="nx">Reply</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">where</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message_id</span><span class="o">:</span> <span class="nx">message_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">reply</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>reply.js 裡面有會新增回覆、修改{id}回覆、刪除{id}回覆等，除此之外還多了兩個 <code>get</code>、<code>deleteMessage</code> 用來取得 version 樂觀鎖以及同步刪除回覆功能，那以下會說明各別負責功用：</p>
<ul>
<li>新增回覆 create()：因為要先確認留言是否被刪除，所以先使用 <code>Message.findOne</code> 檢查留言是否被刪除，在用 <code>Reply.create</code>  新增 reply.message_id 跟 reply.user_id 以及 reply.content。</li>
<li>修改{id}回覆 update()：使用 <code>Reply.update</code> 更新 content 以及 version，且 reply.id 要等於 reply_id 及 reply.message_id 等於 message_id 及 reply.user_id 等於 user_id 及 reply.version 等於 version。</li>
<li>刪除{id}回覆 delete()：使用 <code>Reply.destroy </code> 刪除符合 reply.id 等於 reply_id 跟 reply.message_id 等於 message_id 及 reply.user_id 等於 user_id。</li>
</ul>
<br>
<h2 id="常用指令-sequelize-cli">常用指令 (sequelize-cli)</h2>
<ul>
<li>sequelize db:migrate：將資料表依照 up 內容執行(<a href="https://pin-yi.me/node-restful-api-repository-messageboard/#migrations" target="_blank" rel="noopener noreffer">migrate 檔案</a>)。</li>
<li>sequelize db:migrate:undo:all：將資料表依照 down 內容執行(<a href="https://pin-yi.me/node-restful-api-repository-messageboard/#migrations" target="_blank" rel="noopener noreffer">migrate 檔案</a>)。</li>
<li>sequelize db:seed：產生假資料</li>
</ul>
<br>
<h2 id="postman-測試">Postman 測試</h2>
<h3 id="註冊---成功">註冊 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/register-success.png" title="/images/node-restful-api-repository-messageboard/register-success.png" data-thumbnail="/images/node-restful-api-repository-messageboard/register-success.png" data-sub-html="<h2>註冊 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/register-success.png"
            data-srcset="/images/node-restful-api-repository-messageboard/register-success.png, /images/node-restful-api-repository-messageboard/register-success.png 1.5x, /images/node-restful-api-repository-messageboard/register-success.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/register-success.png" width="700" />
    </a><figcaption class="image-caption">註冊 成功</figcaption>
    </figure>
<br>
<h3 id="註冊---失敗無輸入">註冊 - 失敗(無輸入)</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/register-error-1.png" title="/images/node-restful-api-repository-messageboard/register-error-1.png" data-thumbnail="/images/node-restful-api-repository-messageboard/register-error-1.png" data-sub-html="<h2>註冊 失敗(無輸入)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/register-error-1.png"
            data-srcset="/images/node-restful-api-repository-messageboard/register-error-1.png, /images/node-restful-api-repository-messageboard/register-error-1.png 1.5x, /images/node-restful-api-repository-messageboard/register-error-1.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/register-error-1.png" width="700" />
    </a><figcaption class="image-caption">註冊 失敗(無輸入)</figcaption>
    </figure>
<br>
<h3 id="註冊---失敗已經註冊過">註冊 - 失敗(已經註冊過)</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/register-error-2.png" title="/images/node-restful-api-repository-messageboard/register-error-2.png" data-thumbnail="/images/node-restful-api-repository-messageboard/register-error-2.png" data-sub-html="<h2>註冊 失敗(已經註冊過)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/register-error-2.png"
            data-srcset="/images/node-restful-api-repository-messageboard/register-error-2.png, /images/node-restful-api-repository-messageboard/register-error-2.png 1.5x, /images/node-restful-api-repository-messageboard/register-error-2.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/register-error-2.png" width="700" />
    </a><figcaption class="image-caption">註冊 失敗(已經註冊過)</figcaption>
    </figure>
<br>
<h3 id="登入---成功">登入 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/login-success.png" title="/images/node-restful-api-repository-messageboard/login-success.png" data-thumbnail="/images/node-restful-api-repository-messageboard/login-success.png" data-sub-html="<h2>登入 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/login-success.png"
            data-srcset="/images/node-restful-api-repository-messageboard/login-success.png, /images/node-restful-api-repository-messageboard/login-success.png 1.5x, /images/node-restful-api-repository-messageboard/login-success.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/login-success.png" width="700" />
    </a><figcaption class="image-caption">登入 成功</figcaption>
    </figure>
<br>
<h3 id="登入---失敗">登入 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/login-error.png" title="/images/node-restful-api-repository-messageboard/login-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/login-error.png" data-sub-html="<h2>登入 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/login-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/login-error.png, /images/node-restful-api-repository-messageboard/login-error.png 1.5x, /images/node-restful-api-repository-messageboard/login-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/login-error.png" width="700" />
    </a><figcaption class="image-caption">登入 失敗</figcaption>
    </figure>
<br>
<h3 id="查詢全部留言---成功無資料">查詢全部留言 - 成功(無資料)</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/get-success-1.png" title="/images/node-restful-api-repository-messageboard/get-success-1.png" data-thumbnail="/images/node-restful-api-repository-messageboard/get-success-1.png" data-sub-html="<h2>查詢留言 成功(無資料)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/get-success-1.png"
            data-srcset="/images/node-restful-api-repository-messageboard/get-success-1.png, /images/node-restful-api-repository-messageboard/get-success-1.png 1.5x, /images/node-restful-api-repository-messageboard/get-success-1.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/get-success-1.png" width="700" />
    </a><figcaption class="image-caption">查詢留言 成功(無資料)</figcaption>
    </figure>
<br>
<h3 id="查詢全部留言---成功有資料">查詢全部留言 - 成功(有資料)</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/get-success-2.png" title="/images/node-restful-api-repository-messageboard/get-success-2.png" data-thumbnail="/images/node-restful-api-repository-messageboard/get-success-2.png" data-sub-html="<h2>查詢留言 成功(有資料)</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/get-success-2.png"
            data-srcset="/images/node-restful-api-repository-messageboard/get-success-2.png, /images/node-restful-api-repository-messageboard/get-success-2.png 1.5x, /images/node-restful-api-repository-messageboard/get-success-2.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/get-success-2.png" width="700" />
    </a><figcaption class="image-caption">查詢留言 成功(有資料)</figcaption>
    </figure>
<br>
<h3 id="查詢id留言---成功">查詢{id}留言 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/get-id-succes.png" title="/images/node-restful-api-repository-messageboard/get-id-succes.png" data-thumbnail="/images/node-restful-api-repository-messageboard/get-id-success.png" data-sub-html="<h2>查詢{id}留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/get-id-succes.png"
            data-srcset="/images/node-restful-api-repository-messageboard/get-id-success.png, /images/node-restful-api-repository-messageboard/get-id-succes.png 1.5x, /images/node-restful-api-repository-messageboard/get-id-succes.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/get-id-succes.png" width="700" />
    </a><figcaption class="image-caption">查詢{id}留言 成功</figcaption>
    </figure>
<br>
<h3 id="查詢id留言---失敗">查詢{id}留言 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/get-error.png" title="/images/node-restful-api-repository-messageboard/get-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/get-error.png" data-sub-html="<h2>查詢{id}留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/get-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/get-error.png, /images/node-restful-api-repository-messageboard/get-error.png 1.5x, /images/node-restful-api-repository-messageboard/get-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/get-error.png" width="700" />
    </a><figcaption class="image-caption">查詢{id}留言 失敗</figcaption>
    </figure>
<br>
<h3 id="新增留言---成功">新增留言 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/create.png" title="/images/node-restful-api-repository-messageboard/create.png" data-thumbnail="/images/node-restful-api-repository-messageboard/create.png" data-sub-html="<h2>新增留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/create.png"
            data-srcset="/images/node-restful-api-repository-messageboard/create.png, /images/node-restful-api-repository-messageboard/create.png 1.5x, /images/node-restful-api-repository-messageboard/create.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/create.png" width="700" />
    </a><figcaption class="image-caption">新增留言 成功</figcaption>
    </figure>
<br>
<h3 id="新增留言---失敗">新增留言 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/create-error.png" title="/images/node-restful-api-repository-messageboard/create-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/create-error.png" data-sub-html="<h2>新增留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/create-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/create-error.png, /images/node-restful-api-repository-messageboard/create-error.png 1.5x, /images/node-restful-api-repository-messageboard/create-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/create-error.png" width="700" />
    </a><figcaption class="image-caption">新增留言 失敗</figcaption>
    </figure>
<br>
<h3 id="修改id留言---成功">修改{id}留言 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/patch-success.png" title="/images/node-restful-api-repository-messageboard/patch-success.png" data-thumbnail="/images/node-restful-api-repository-messageboard/patch-success.png" data-sub-html="<h2>修改 {id}留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/patch-success.png"
            data-srcset="/images/node-restful-api-repository-messageboard/patch-success.png, /images/node-restful-api-repository-messageboard/patch-success.png 1.5x, /images/node-restful-api-repository-messageboard/patch-success.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/patch-success.png" width="700" />
    </a><figcaption class="image-caption">修改 {id}留言 成功</figcaption>
    </figure>
<br>
<h3 id="修改id留言---失敗">修改{id}留言 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/patch-error.png" title="/images/node-restful-api-repository-messageboard/patch-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/patch-error.png" data-sub-html="<h2>修改 {id}留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/patch-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/patch-error.png, /images/node-restful-api-repository-messageboard/patch-error.png 1.5x, /images/node-restful-api-repository-messageboard/patch-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/patch-error.png" width="700" />
    </a><figcaption class="image-caption">修改 {id}留言 失敗</figcaption>
    </figure>
<br>
<h3 id="刪除id留言---成功">刪除{id}留言 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/delete.png" title="/images/node-restful-api-repository-messageboard/delete.png" data-thumbnail="/images/node-restful-api-repository-messageboard/delete.png" data-sub-html="<h2>刪除 {id}留言 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/delete.png"
            data-srcset="/images/node-restful-api-repository-messageboard/delete.png, /images/node-restful-api-repository-messageboard/delete.png 1.5x, /images/node-restful-api-repository-messageboard/delete.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/delete.png" width="700" />
    </a><figcaption class="image-caption">刪除 {id}留言 成功</figcaption>
    </figure>
<br>
<h3 id="刪除id留言---失敗">刪除{id}留言 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/delete-error.png" title="/images/node-restful-api-repository-messageboard/delete-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/delete-error.png" data-sub-html="<h2>刪除 {id}留言 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/delete-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/delete-error.png, /images/node-restful-api-repository-messageboard/delete-error.png 1.5x, /images/node-restful-api-repository-messageboard/delete-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/delete-error.png" width="700" />
    </a><figcaption class="image-caption">刪除 {id}留言 失敗</figcaption>
    </figure>
<br>
<h3 id="新增回覆---成功">新增回覆 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-create.png" title="/images/node-restful-api-repository-messageboard/reply-create.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-create.png" data-sub-html="<h2>新增回覆 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-create.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-create.png, /images/node-restful-api-repository-messageboard/reply-create.png 1.5x, /images/node-restful-api-repository-messageboard/reply-create.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-create.png" width="700" />
    </a><figcaption class="image-caption">新增回覆 成功</figcaption>
    </figure>
<br>
<h3 id="新增回覆---失敗">新增回覆 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-create-error.png" title="/images/node-restful-api-repository-messageboard/reply-create-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-create-error.png" data-sub-html="<h2>新增回覆 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-create-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-create-error.png, /images/node-restful-api-repository-messageboard/reply-create-error.png 1.5x, /images/node-restful-api-repository-messageboard/reply-create-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-create-error.png" width="700" />
    </a><figcaption class="image-caption">新增回覆 失敗</figcaption>
    </figure>
<br>
<h3 id="修改id回覆---成功">修改{id}回覆 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-patch-success.png" title="/images/node-restful-api-repository-messageboard/reply-patch-success.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-patch-success.png" data-sub-html="<h2>修改 {id}回覆 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-patch-success.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-patch-success.png, /images/node-restful-api-repository-messageboard/reply-patch-success.png 1.5x, /images/node-restful-api-repository-messageboard/reply-patch-success.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-patch-success.png" width="700" />
    </a><figcaption class="image-caption">修改 {id}回覆 成功</figcaption>
    </figure>
<br>
<h3 id="修改id回覆---失敗">修改{id}回覆 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-patch-error.png" title="/images/node-restful-api-repository-messageboard/reply-patch-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-patch-error.png" data-sub-html="<h2>修改 {id}回覆 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-patch-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-patch-error.png, /images/node-restful-api-repository-messageboard/reply-patch-error.png 1.5x, /images/node-restful-api-repository-messageboard/reply-patch-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-patch-error.png" width="700" />
    </a><figcaption class="image-caption">修改 {id}回覆 失敗</figcaption>
    </figure>
<br>
<h3 id="刪除id回覆---成功">刪除{id}回覆 - 成功</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-delete.png" title="/images/node-restful-api-repository-messageboard/reply-delete.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-delete.png" data-sub-html="<h2>刪除 {id}回覆 成功</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-delete.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-delete.png, /images/node-restful-api-repository-messageboard/reply-delete.png 1.5x, /images/node-restful-api-repository-messageboard/reply-delete.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-delete.png" width="700" />
    </a><figcaption class="image-caption">刪除 {id}回覆 成功</figcaption>
    </figure>
<br>
<h3 id="刪除id回覆---失敗">刪除{id}回覆 - 失敗</h3>
<figure><a class="lightgallery" href="/images/node-restful-api-repository-messageboard/reply-delete-error.png" title="/images/node-restful-api-repository-messageboard/reply-delete-error.png" data-thumbnail="/images/node-restful-api-repository-messageboard/reply-delete-error.png" data-sub-html="<h2>刪除 {id}回覆 失敗</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/node-restful-api-repository-messageboard/reply-delete-error.png"
            data-srcset="/images/node-restful-api-repository-messageboard/reply-delete-error.png, /images/node-restful-api-repository-messageboard/reply-delete-error.png 1.5x, /images/node-restful-api-repository-messageboard/reply-delete-error.png 2x"
            data-sizes="auto"
            alt="/images/node-restful-api-repository-messageboard/reply-delete-error.png" width="700" />
    </a><figcaption class="image-caption">刪除 {id}回覆 失敗</figcaption>
    </figure>
<br>
<h2 id="參考資料">參考資料</h2>
<p><a href="https://nodejs.dev/learn/introduction-to-nodejs" target="_blank" rel="noopener noreffer">Node.js 官網</a></p>
<p><a href="https://sequelize.org/v6/index.html" target="_blank" rel="noopener noreffer">Sequelize
</a></p>
<p><a href="https://hackmd.io/@TSMI_E7ORNeP8YBbWm-lFA/ryCtaVW_M?print-pdf#%E4%BD%BF%E7%94%A8sequelize%E5%BB%BA%E7%AB%8B%E4%B8%80%E5%BC%B5user-table" target="_blank" rel="noopener noreffer">透過 sequelize 來達成 DB Schema Migration
</a></p>
<p><a href="https://sebhastian.com/sequelize-join/" target="_blank" rel="noopener noreffer">How to create JOIN queries with Sequelize
</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/node.js/">Node.js</a>
                </span><span><a href="/tags/restful-api/">RESTful API</a>
                </span><span><a href="/tags/mysql/">Mysql</a>
                </span><span><a href="/tags/repository/">Repository</a>
                </span><span><a href="/tags/%E5%AF%A6%E4%BD%9C/">實作</a>
                </span><span><a href="/tags/%E4%BB%8B%E7%B4%B9/">介紹</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>更新於 2022-04-11&nbsp;<a class="git-hash" href="https://github.com/880831ian/blog/commit/66c6f146e0a9f2e36cc652ae425b7037643923c2" target="_blank" title="committed&nbsp;by&nbsp;ian_zhuang(880831ian@gmail.com)&nbsp;66c6f14:&nbsp;# 新增 Node Repository Restful API 的留言板">
                            <i class="fas fa-hashtag fa-fw"></i>66c6f14</a></span>
            </div><div class="post-info-mod"><span>
                            <a class="link-to-markdown" href="/node-restful-api-repository-messageboard/index.md" target="_blank">閱讀原始文檔</a>
                        </span><span>
                        &nbsp;|&nbsp;
                        <a class="link-to-markdown" href="https://github.com/880831ian/blog/tree/main/content/posts/node-restful-api-repository-messageboard/index.zh-tw.md" target="_blank">Improve Article</a>
                    </span></div>
        </div><div class="post-info-share">
            <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/" data-title="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)" data-hashtags="Node.js,RESTful API,Mysql,Repository,實作,介紹"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/" data-hashtag="Node.js"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/" data-title="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)"><i class="fab fa-line fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/" data-title="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Skype" data-sharer="skype" data-url="https://pin-yi.me/node-restful-api-repository-messageboard/" data-title="用 Node.js寫一個 Repository Restful API 的留言板 (express、sequelize 套件)"><i class="fab fa-skype fa-fw"></i></a></span>
        </div></div><div class="post-nav"><a href="/node/" class="prev" rel="prev" title="Node.js 介紹"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/git/" class="next" rel="next" title="Git 介紹">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div><div id="comments" class="single-card"><div id="disqus_thread"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://pin-yi.me">PinYi</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
</div>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker
        .register('/sw.min.js?version=1.0.1', { scope: '/' })
        .then(() => {
            console.info('PinYi\u00A0Service Worker Registered');
        }, err => console.error('PinYi\u00A0Service Worker registration failed: ', err));

    navigator.serviceWorker
        .ready
        .then(() => {
            console.info('PinYi\u00A0Service Worker Ready');
        });
}
</script>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到頂部">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看評論">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/css/lightgallery.min.css"><script src="https://pin-yi.disqus.com/embed.js" defer></script><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.0/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.1-beta.0/dist/js/lightgallery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.3.0/dist/lg-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.1/sharer.min.js"></script><script>window.config={"code":{"copyTitle":"複製到剪貼板","maxShownLines":120},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"找不到你輸入的資料🥲","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body></html>
